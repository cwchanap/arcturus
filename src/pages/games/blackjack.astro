---
import CasinoLayout from '../../layouts/casino.astro';

const user = Astro.locals.user;

if (!user) {
	return Astro.redirect('/signin');
}

const initialBalance = user.chipBalance || 1000;
---

<CasinoLayout title="Blackjack - Arcturus Casino">
	<div
		id="blackjack-root"
		data-user-id={user.id}
		class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8"
	>
		<!-- Game Header -->
		<div class="flex items-center justify-between mb-8">
			<div>
				<a
					href="/games"
					class="text-slate-400 hover:text-yellow-400 transition-colors mb-2 inline-block"
				>
					‚Üê Back to Games
				</a>
				<h1
					class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-500"
				>
					Blackjack
				</h1>
			</div>
			<div class="flex items-center gap-4">
				<div class="bg-slate-800 px-6 py-3 rounded-lg border border-yellow-500/30">
					<div class="text-xs text-slate-400 mb-1">Your Balance</div>
					<div class="text-2xl font-bold text-yellow-400" id="player-balance">
						${initialBalance}
					</div>
				</div>
			</div>
		</div>

		<!-- Blackjack Table -->
		<div class="felt-table rounded-3xl p-8 mb-8 relative min-h-[600px]">
			<!-- Game Status Message -->
			<div class="absolute top-4 left-1/2 -translate-x-1/2 text-center">
				<div
					id="game-status"
					class="text-lg font-semibold text-yellow-400 bg-slate-900/80 backdrop-blur-sm px-6 py-2 rounded-full border border-yellow-500/30"
				>
					Place your bet to start
				</div>
			</div>

			<!-- Dealer Area -->
			<div class="absolute top-20 left-1/2 -translate-x-1/2 w-full max-w-md">
				<div class="text-center mb-4">
					<div class="text-sm text-slate-400 mb-2">Dealer</div>
					<div id="dealer-value" class="text-xl font-bold text-white mb-4">-</div>
				</div>
				<div id="dealer-cards" class="flex justify-center gap-3 min-h-[120px]">
					<!-- Dealer cards will be rendered here -->
				</div>
			</div>

			<!-- Player Area -->
			<div class="absolute bottom-20 left-1/2 -translate-x-1/2 w-full max-w-md">
				<div id="player-cards" class="flex justify-center gap-3 min-h-[120px] mb-4">
					<!-- Player cards will be rendered here -->
				</div>
				<div class="text-center">
					<div id="player-value" class="text-xl font-bold text-white mb-2">-</div>
					<div id="current-bet" class="text-sm text-slate-400">Bet: $0</div>
				</div>
			</div>

			<!-- Betting Controls -->
			<div
				id="betting-controls"
				class="absolute bottom-4 left-1/2 -translate-x-1/2 w-full max-w-lg"
			>
				<div class="bg-slate-900/80 backdrop-blur-sm rounded-2xl p-6 border border-slate-700">
					<div class="mb-4">
						<label for="bet-amount" class="block text-sm text-slate-400 mb-2">Bet Amount</label>
						<input
							type="number"
							id="bet-amount"
							min="10"
							max="500"
							value="50"
							step="10"
							class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-yellow-500 focus:outline-none"
						/>
					</div>
					<div class="flex gap-2 mb-4">
						<button
							class="bet-quick flex-1 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 transition-colors"
							data-amount="25">$25</button
						>
						<button
							class="bet-quick flex-1 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 transition-colors"
							data-amount="50">$50</button
						>
						<button
							class="bet-quick flex-1 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 transition-colors"
							data-amount="100">$100</button
						>
						<button
							class="bet-quick flex-1 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 transition-colors"
							data-amount="200">$200</button
						>
					</div>
					<button
						id="btn-deal"
						class="w-full bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-600 hover:to-amber-700 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105"
					>
						Deal
					</button>
				</div>
			</div>

			<!-- Game Controls -->
			<div
				id="game-controls"
				class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 w-full max-w-lg"
			>
				<div class="bg-slate-900/80 backdrop-blur-sm rounded-2xl p-6 border border-slate-700">
					<div class="grid grid-cols-2 gap-3 mb-3">
						<button
							id="btn-hit"
							class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
						>
							Hit
						</button>
						<button
							id="btn-stand"
							class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
						>
							Stand
						</button>
						<button
							id="btn-double"
							class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
							title="Double your bet and receive one card"
						>
							Double Down
						</button>
						<button
							id="btn-split"
							class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
							title="Split your pair into two hands"
						>
							Split
						</button>
					</div>

					<!-- AI Rival Section -->
					<div class="border-t border-slate-600 pt-3 mt-3">
						<div class="flex items-center gap-3">
							<button
								id="btn-ai-rival"
								class="flex-1 bg-gradient-to-r from-cyan-500 to-teal-600 hover:from-cyan-600 hover:to-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
								title="Get AI strategy advice"
							>
								<span>ü§ñ</span>
								<span id="btn-ai-rival-text">Ask AI Rival</span>
							</button>
						</div>
						<div
							id="ai-advice-box"
							class="hidden mt-3 p-3 bg-slate-800/80 rounded-lg border border-cyan-500/30"
						>
							<div class="flex items-start gap-2">
								<span class="text-cyan-400">üí°</span>
								<div>
									<div id="ai-advice-action" class="font-bold text-cyan-400 mb-1"></div>
									<div id="ai-advice-reasoning" class="text-sm text-slate-300"></div>
								</div>
							</div>
						</div>
					</div>

					<button
						id="btn-new-round"
						class="hidden w-full mt-3 bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-600 hover:to-amber-700 text-slate-900 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105"
					>
						New Round
					</button>
				</div>
			</div>

			<!-- AI Commentary Box (shown after round) -->
			<div
				id="ai-commentary-box"
				class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900/95 backdrop-blur-sm rounded-2xl p-6 border border-cyan-500/50 max-w-sm text-center z-10"
			>
				<div class="text-4xl mb-3">üé∞</div>
				<div id="ai-commentary-text" class="text-lg text-slate-200"></div>
			</div>
		</div>

		<!-- LLM Configuration Overlay -->
		<div
			id="llm-config-overlay"
			class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center"
		>
			<div class="bg-slate-900 rounded-2xl p-8 max-w-md mx-4 border border-slate-700">
				<div class="text-center mb-6">
					<div class="text-5xl mb-4">ü§ñ</div>
					<h2 class="text-2xl font-bold text-white mb-2">AI Rival Not Configured</h2>
					<p class="text-slate-400">
						To get AI-powered strategy advice, you need to configure your API key in your profile
						settings.
					</p>
				</div>
				<div class="space-y-3">
					<a
						href="/profile"
						class="block w-full bg-gradient-to-r from-cyan-500 to-teal-600 hover:from-cyan-600 hover:to-teal-700 text-white font-bold py-3 px-6 rounded-lg text-center transition-all"
					>
						Configure API Key
					</a>
					<button
						id="btn-close-overlay"
						class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 px-6 rounded-lg transition-colors border border-slate-600"
					>
						Play Without AI
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Game Settings Panel -->
	<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-10">
		<div class="mt-6 p-4 bg-slate-900 rounded-xl border border-slate-700">
			<div class="flex items-center justify-between mb-3">
				<div class="text-sm text-slate-400">Game Settings</div>
				<button
					id="btn-toggle-settings"
					class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded transition"
				>
					‚öôÔ∏è Configure
				</button>
			</div>
			<div id="settings-panel" class="hidden mt-4 space-y-4">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label class="block text-xs text-slate-400 mb-1" for="setting-starting-chips"
							>Starting Chips</label
						>
						<input
							type="number"
							id="setting-starting-chips"
							class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							min="100"
							max="10000"
							step="100"
						/>
					</div>
					<div>
						<label class="block text-xs text-slate-400 mb-1" for="setting-min-bet"
							>Minimum Bet</label
						>
						<input
							type="number"
							id="setting-min-bet"
							class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							min="1"
							max="1000"
							step="5"
						/>
					</div>
					<div>
						<label class="block text-xs text-slate-400 mb-1" for="setting-max-bet"
							>Maximum Bet</label
						>
						<input
							type="number"
							id="setting-max-bet"
							class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							min="10"
							max="5000"
							step="10"
						/>
					</div>
					<div>
						<label class="block text-xs text-slate-400 mb-1" for="setting-dealer-speed"
							>Dealer Speed</label
						>
						<select
							id="setting-dealer-speed"
							class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
						>
							<option value="slow">Slow (1.5s)</option>
							<option value="normal">Normal (1.0s)</option>
							<option value="fast">Fast (0.5s)</option>
						</select>
					</div>
				</div>
				<div class="p-4 bg-slate-900 rounded-lg border border-slate-600">
					<div class="flex items-center gap-3">
						<input
							type="checkbox"
							id="setting-use-llm"
							class="w-5 h-5 bg-slate-800 border-slate-600 rounded text-yellow-500 focus:ring-2 focus:ring-yellow-500"
						/>
						<label for="setting-use-llm" class="flex-1">
							<div class="text-sm text-white font-semibold">Use LLM-Powered AI Rival</div>
							<div class="text-xs text-slate-400 mt-1">
								Enable OpenAI/Gemini-powered advice and commentary. Requires API key configured in
								your profile.
							</div>
						</label>
					</div>
				</div>
				<div class="flex gap-2 pt-2">
					<button
						id="btn-save-settings"
						class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-semibold transition"
					>
						Save Settings
					</button>
					<button
						id="btn-reset-settings"
						class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded transition"
					>
						Reset
					</button>
				</div>
				<p class="text-xs text-slate-500">
					‚ö†Ô∏è Settings apply to new rounds only. Finish the current round or start a new one after
					saving.
				</p>
			</div>
		</div>
	</div>
</CasinoLayout>

<style>
	.felt-table {
		background: radial-gradient(ellipse at center, #1e7b4e 0%, #165c3a 100%);
		box-shadow:
			inset 0 2px 4px rgba(0, 0, 0, 0.3),
			0 4px 8px rgba(0, 0, 0, 0.2);
	}

	.card {
		width: 80px;
		height: 112px;
		background: white;
		border-radius: 8px;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		font-size: 24px;
		font-weight: bold;
		box-shadow:
			0 2px 8px rgba(0, 0, 0, 0.2),
			0 0 0 1px rgba(0, 0, 0, 0.1);
		animation: card-deal 0.3s ease-out;
	}

	.card-hidden {
		background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
		color: #475569;
		font-size: 48px;
	}

	.card[data-suit='hearts'],
	.card[data-suit='diamonds'] {
		color: #dc2626;
	}

	.card[data-suit='clubs'],
	.card[data-suit='spades'] {
		color: #1e293b;
	}

	@keyframes card-deal {
		from {
			opacity: 0;
			transform: translateY(-20px) scale(0.8);
		}
		to {
			opacity: 1;
			transform: translateY(0) scale(1);
		}
	}
</style>

<script>
	import { initBlackjackClient } from '../../lib/blackjack/blackjackClient';

	initBlackjackClient();
</script>

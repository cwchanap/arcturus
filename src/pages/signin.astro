---
import CasinoLayout from '../layouts/casino.astro';
---

<CasinoLayout title="Sign In - Arcturus Casino">
	<div class="min-h-[80vh] flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
		<div class="max-w-md w-full">
			<!-- Casino-themed card -->
			<div
				class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-8 border border-yellow-500/20 shadow-2xl"
			>
				<!-- Header -->
				<div class="text-center mb-8">
					<div class="text-6xl mb-4">üé∞</div>
					<h2
						class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-500"
					>
						Welcome Back!
					</h2>
					<p class="mt-2 text-slate-400">Sign in to continue the fun with virtual chips</p>
				</div>

				<!-- Sign In Form -->
				<form class="space-y-6" id="signin-form">
					<div>
						<label for="email-address" class="block text-sm font-medium text-slate-300 mb-2">
							Email Address
						</label>
						<input
							id="email-address"
							name="email"
							type="email"
							autocomplete="email"
							required
							class="w-full px-4 py-3 bg-slate-900/50 border border-yellow-500/30 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all"
							placeholder="Enter your email"
						/>
					</div>

					<div>
						<label for="password" class="block text-sm font-medium text-slate-300 mb-2">
							Password
						</label>
						<input
							id="password"
							name="password"
							type="password"
							autocomplete="current-password"
							required
							class="w-full px-4 py-3 bg-slate-900/50 border border-yellow-500/30 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all"
							placeholder="Enter your password"
						/>
					</div>

					<div>
						<button
							type="submit"
							class="w-full py-4 bg-gradient-to-r from-yellow-400 via-amber-500 to-yellow-600 rounded-lg font-bold text-lg text-slate-900 hover:from-yellow-300 hover:to-amber-400 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-yellow-500/50"
						>
							üéÆ Sign In & Play
						</button>
					</div>

					<div class="text-center">
						<a
							href="/signup"
							class="text-yellow-400 hover:text-yellow-300 font-medium transition-colors"
						>
							Don't have an account? <span class="underline">Join free and get 10,000 chips!</span>
						</a>
					</div>
				</form>
			</div>

			<!-- Back to Home -->
			<div class="text-center mt-6">
				<a href="/" class="text-slate-400 hover:text-yellow-400 transition-colors">
					‚Üê Back to Home
				</a>
			</div>
		</div>
	</div>
</CasinoLayout>

<script>
	import { authClient } from '../lib/auth-client';

	const form = document.getElementById('signin-form') as HTMLFormElement;

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(form);
		const email = formData.get('email') as string;
		const password = formData.get('password') as string;

		try {
			const result = await authClient.signIn.email({
				email,
				password,
			});
			// Check if the result indicates success before redirecting
			if (result?.data?.user || result?.url) {
				window.location.href = '/';
			}
		} catch (error: unknown) {
			console.error('Sign in error:', error);
			// Prevent default was already called at the start of the submit handler.
			// Here we only handle/log the error and show user feedback.

			// Try to get more specific error information without using `any`.
			let errorMessage = 'Sign in failed. Please check your credentials.';

			if (typeof error === 'string') {
				errorMessage = `Sign in failed: ${error}`;
			} else if (error instanceof Error && error.message) {
				errorMessage = `Sign in failed: ${error.message}`;
			} else if (error && typeof error === 'object') {
				const maybe = error as Record<string, unknown>;
				const data = maybe.data as Record<string, unknown> | undefined;
				if (data && typeof data.message === 'string') {
					errorMessage = `Sign in failed: ${data.message}`;
				} else if (typeof maybe.statusText === 'string') {
					errorMessage = `Sign in failed: ${maybe.statusText}`;
				}
			}

			// Show error message in the page instead of redirecting
			showErrorMessage(errorMessage);
		}
	});

	function showErrorMessage(message: string) {
		// Remove any existing error messages
		const existingError = document.querySelector('.error-message');
		if (existingError) {
			existingError.remove();
		}

		// Create error message element
		const errorDiv = document.createElement('div');
		errorDiv.className =
			'error-message mb-4 p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm';
		errorDiv.textContent = message;

		// Insert error message at the top of the form
		const form = document.getElementById('signin-form');
		form?.insertBefore(errorDiv, form.firstChild);
	}
</script>

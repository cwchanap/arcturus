---
import CasinoLayout from '../../layouts/casino.astro';
import PokerChip from '../../components/PokerChip.astro';

const user = Astro.locals.user;

if (!user) {
	return Astro.redirect('/signin');
}
---

<CasinoLayout title="Texas Hold'em Poker - Arcturus Casino">
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Game Header -->
		<div class="flex items-center justify-between mb-8">
			<div>
				<a
					href="/#games"
					class="text-slate-400 hover:text-yellow-400 transition-colors mb-2 inline-block"
				>
					‚Üê Back to Games
				</a>
				<h1
					class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-500"
				>
					Texas Hold'em Poker
				</h1>
			</div>
			<div class="flex items-center gap-4">
				<div class="bg-slate-800 px-6 py-3 rounded-lg border border-yellow-500/30">
					<div class="text-xs text-slate-400 mb-1">Your Balance</div>
					<div class="text-2xl font-bold text-yellow-400" id="player-balance">$1,000</div>
				</div>
			</div>
		</div>

		<!-- Poker Table -->
		<div class="felt-table p-6 md:p-8 mb-6 relative" style="min-height: 580px;">
			<!-- Pot Display - Top Center -->
			<div class="absolute top-6 left-1/2 -translate-x-1/2 z-10">
				<div
					class="bg-slate-900/90 backdrop-blur-sm px-5 py-2.5 rounded-full border-2 border-yellow-500/50 shadow-lg"
				>
					<div class="text-xs text-slate-400 text-center mb-0.5">POT</div>
					<div class="text-xl font-bold text-yellow-400" id="pot-amount">$0</div>
				</div>
			</div>

			<!-- Community Cards - Center -->
			<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -mt-4">
				<div class="flex gap-2 md:gap-3" id="community-cards">
					<div
						class="w-14 h-20 md:w-16 md:h-24 bg-slate-800/40 rounded-lg border-2 border-dashed border-slate-600/60 flex items-center justify-center text-slate-500 text-lg"
					>
						?
					</div>
					<div
						class="w-14 h-20 md:w-16 md:h-24 bg-slate-800/40 rounded-lg border-2 border-dashed border-slate-600/60 flex items-center justify-center text-slate-500 text-lg"
					>
						?
					</div>
					<div
						class="w-14 h-20 md:w-16 md:h-24 bg-slate-800/40 rounded-lg border-2 border-dashed border-slate-600/60 flex items-center justify-center text-slate-500 text-lg"
					>
						?
					</div>
					<div
						class="w-14 h-20 md:w-16 md:h-24 bg-slate-800/40 rounded-lg border-2 border-dashed border-slate-600/60 flex items-center justify-center text-slate-500 text-lg"
					>
						?
					</div>
					<div
						class="w-14 h-20 md:w-16 md:h-24 bg-slate-800/40 rounded-lg border-2 border-dashed border-slate-600/60 flex items-center justify-center text-slate-500 text-lg"
					>
						?
					</div>
				</div>
			</div>

			<!-- LLM Configuration Overlay -->
			<div
				id="llm-overlay"
				class="hidden absolute inset-0 z-40 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center rounded-[50%/38%]"
			>
				<div
					class="max-w-md w-full mx-4 bg-slate-900 border border-slate-700 rounded-2xl p-6 shadow-2xl flex flex-col gap-3"
				>
					<div class="flex items-center gap-3">
						<div
							class="h-10 w-10 flex items-center justify-center rounded-xl bg-slate-800 text-yellow-400"
						>
							‚ö†Ô∏è
						</div>
						<div>
							<h2 class="text-lg font-semibold text-white">LLM Poker Rival not configured</h2>
							<p class="text-xs text-slate-400">
								LLM-powered AI is enabled in your game settings, but no API key is configured.
							</p>
						</div>
					</div>
					<p class="text-sm text-slate-300">
						Add an OpenAI or Gemini API key in your profile to unlock AI-powered poker rivals. You
						can also disable the LLM option in Game Settings to play with built-in AI only.
					</p>
					<div class="flex flex-wrap gap-2 mt-2">
						<a
							href="/profile"
							class="inline-flex items-center justify-center gap-2 rounded-lg bg-yellow-500/90 px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-yellow-400 transition"
						>
							Configure API Key
						</a>
						<button
							id="llm-overlay-close"
							type="button"
							class="inline-flex items-center justify-center gap-2 rounded-lg bg-slate-800 px-4 py-2 text-xs font-semibold text-slate-300 hover:bg-slate-700 border border-slate-600 transition"
						>
							Play without LLM
						</button>
					</div>
				</div>
			</div>

			<!-- Opponents - Arc positioning around oval table -->
			<!-- Opponent 1: Top-Left (10 o'clock position) -->
			<div class="absolute top-16 left-6 md:left-12">
				<div
					class="bg-slate-900/85 backdrop-blur-sm p-2.5 md:p-3 rounded-lg border border-slate-600/80 shadow-lg"
				>
					<div class="text-xs text-slate-300 mb-1.5 font-medium">Player 2</div>
					<div class="flex gap-1.5 mb-1.5" id="opponent1-cards">
						<div
							class="opponent-card-small playing-card w-12 h-16 flex items-center justify-center"
						>
							<div
								class="w-full h-full bg-gradient-to-br from-blue-600 to-blue-800 rounded flex items-center justify-center"
							>
								<div class="text-white text-xl">üÇ†</div>
							</div>
						</div>
						<div
							class="opponent-card-small playing-card w-12 h-16 flex items-center justify-center"
						>
							<div
								class="w-full h-full bg-gradient-to-br from-blue-600 to-blue-800 rounded flex items-center justify-center"
							>
								<div class="text-white text-xl">üÇ†</div>
							</div>
						</div>
					</div>
					<div class="text-xs text-yellow-400 font-semibold" id="opponent1-chips">$500</div>
				</div>
			</div>

			<!-- Opponent 2: Top-Right (2 o'clock position) -->
			<div class="absolute top-16 right-6 md:right-12">
				<div
					class="bg-slate-900/85 backdrop-blur-sm p-2.5 md:p-3 rounded-lg border border-slate-600/80 shadow-lg"
				>
					<div class="text-xs text-slate-300 mb-1.5 font-medium">Player 3</div>
					<div class="flex gap-1.5 mb-1.5" id="opponent2-cards">
						<div
							class="opponent-card-small playing-card w-12 h-16 flex items-center justify-center"
						>
							<div
								class="w-full h-full bg-gradient-to-br from-blue-600 to-blue-800 rounded flex items-center justify-center"
							>
								<div class="text-white text-xl">üÇ†</div>
							</div>
						</div>
						<div
							class="opponent-card-small playing-card w-12 h-16 flex items-center justify-center"
						>
							<div
								class="w-full h-full bg-gradient-to-br from-blue-600 to-blue-800 rounded flex items-center justify-center"
							>
								<div class="text-white text-xl">üÇ†</div>
							</div>
						</div>
					</div>
					<div class="text-xs text-yellow-400 font-semibold" id="opponent2-chips">$750</div>
				</div>
			</div>

			<!-- Player's Hand with Integrated Controls -->
			<div class="absolute bottom-4 md:bottom-6 left-1/2 -translate-x-1/2 w-full max-w-xl px-3">
				<div
					class="bg-slate-900/95 backdrop-blur-sm p-4 md:p-5 rounded-xl border-2 border-yellow-500/40 player-area-glow"
				>
					<!-- Hand Display -->
					<div class="text-center mb-3">
						<div class="text-xs text-slate-400 mb-0.5">Your Hand</div>
						<div class="text-base md:text-lg font-bold text-yellow-400" id="hand-strength">--</div>
					</div>
					<div class="flex gap-2 md:gap-3 justify-center mb-3" id="player-cards">
						<!-- Cards will be inserted here by JavaScript -->
					</div>

					<!-- Integrated Betting Controls -->
					<div class="border-t border-slate-700/50 pt-3 space-y-2.5">
						<!-- Action Buttons Row -->
						<div class="grid grid-cols-4 gap-1.5 md:gap-2">
							<button id="btn-fold" class="action-btn bg-red-600 hover:bg-red-700 text-white">
								Fold
							</button>
							<button id="btn-check" class="action-btn bg-blue-600 hover:bg-blue-700 text-white">
								Check
							</button>
							<button id="btn-call" class="action-btn bg-green-600 hover:bg-green-700 text-white">
								Call
							</button>
							<button
								id="btn-raise"
								class="action-btn bg-gradient-to-r from-yellow-500 to-amber-500 hover:from-yellow-600 hover:to-amber-600 text-slate-900"
							>
								Raise
							</button>
						</div>

						<!-- Bet Slider Row -->
						<div class="flex gap-2 items-center px-1">
							<input
								type="range"
								id="bet-slider"
								min="10"
								max="1000"
								step="10"
								value="50"
								class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-yellow-500"
							/>
							<span
								id="bet-amount"
								class="text-yellow-400 font-bold min-w-[60px] text-right text-sm">$50</span
							>
						</div>

						<!-- Quick Bet Chips Row -->
						<div class="flex justify-center gap-2 md:gap-3">
							<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="10">
								<PokerChip value={10} color="red" />
							</button>
							<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="25">
								<PokerChip value={25} color="blue" />
							</button>
							<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="50">
								<PokerChip value={50} color="green" />
							</button>
							<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="100">
								<PokerChip value={100} color="black" />
							</button>
						</div>

						<!-- Current Bet Display -->
						<div class="text-center text-sm text-yellow-400/80">
							Your Bet: <span id="current-bet" class="font-semibold">$0</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Game Controls - Simplified (main controls now in table) -->
		<div class="bg-slate-900 rounded-xl p-5 border border-slate-700">
			<!-- Deal Button + Game Status -->
			<div class="flex flex-col md:flex-row md:items-center gap-4 mb-5">
				<button
					id="btn-deal"
					class="btn-gold py-3 px-8 rounded-lg font-bold text-lg md:w-auto w-full"
				>
					DEAL NEW HAND
				</button>
				<div class="flex-1 p-3 bg-slate-800/60 rounded-lg border border-slate-700/50">
					<div class="text-xs text-slate-400 mb-0.5">Game Status</div>
					<div id="game-status" class="text-base font-semibold text-yellow-400">
						Click "DEAL NEW HAND" to start
					</div>
				</div>
			</div>

			<div class="mt-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
				<div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
					<div>
						<div class="text-sm text-slate-400 mb-1">AI Rival</div>
						<div id="ai-rival-status" class="text-sm text-slate-300">Loading rival settings‚Ä¶</div>
					</div>
					<button
						id="btn-ai-move"
						class="inline-flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:from-blue-400 hover:to-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
					>
						Ask AI Rival
					</button>
				</div>
				<p class="mt-3 text-xs text-slate-500">
					Configure API keys in your
					<a href="/profile" class="text-yellow-400 hover:underline">profile settings</a>
					to enable Gemini or OpenAI rivals.
				</p>
			</div>

			<!-- Game Settings -->
			<div class="mt-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
				<div class="flex items-center justify-between mb-3">
					<div class="text-sm text-slate-400">Game Settings</div>
					<button
						id="btn-toggle-settings"
						class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded transition"
					>
						‚öôÔ∏è Configure
					</button>
				</div>

				<!-- Collapsible Settings Panel -->
				<div id="settings-panel" class="hidden mt-4 space-y-4">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<!-- Starting Chips -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Starting Chips</label>
							<input
								type="number"
								id="setting-starting-chips"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
								min="100"
								max="10000"
								step="100"
							/>
						</div>

						<!-- Small Blind -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Small Blind</label>
							<input
								type="number"
								id="setting-small-blind"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
								min="1"
								max="100"
								step="1"
							/>
						</div>

						<!-- Big Blind -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Big Blind</label>
							<input
								type="number"
								id="setting-big-blind"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
								min="2"
								max="200"
								step="1"
							/>
						</div>

						<!-- AI Speed -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">AI Speed</label>
							<select
								id="setting-ai-speed"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							>
								<option value="slow">Slow (1.5-2.5s)</option>
								<option value="normal">Normal (0.8-1.5s)</option>
								<option value="fast">Fast (0.3-0.6s)</option>
							</select>
						</div>

						<!-- AI Player 2 Personality -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Player 2 Style</label>
							<select
								id="setting-ai-personality-1"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							>
								<option value="tight-aggressive">Tight-Aggressive</option>
								<option value="loose-aggressive">Loose-Aggressive</option>
								<option value="tight-passive">Tight-Passive</option>
								<option value="loose-passive">Loose-Passive</option>
							</select>
						</div>

						<!-- AI Player 3 Personality -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Player 3 Style</label>
							<select
								id="setting-ai-personality-2"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							>
								<option value="tight-aggressive">Tight-Aggressive</option>
								<option value="loose-aggressive">Loose-Aggressive</option>
								<option value="tight-passive">Tight-Passive</option>
								<option value="loose-passive">Loose-Passive</option>
							</select>
						</div>
					</div>

					<!-- LLM AI Toggle -->
					<div class="p-4 bg-slate-900 rounded-lg border border-slate-600">
						<div class="flex items-center gap-3">
							<input
								type="checkbox"
								id="setting-use-llm-ai"
								class="w-5 h-5 bg-slate-800 border-slate-600 rounded text-yellow-500 focus:ring-2 focus:ring-yellow-500"
							/>
							<label for="setting-use-llm-ai" class="flex-1">
								<div class="text-sm text-white font-semibold">Use LLM-Powered AI Opponents</div>
								<div class="text-xs text-slate-400 mt-1">
									Enable OpenAI/Gemini for smarter, more human-like AI play. Requires API key
									configured in profile.
								</div>
							</label>
						</div>
					</div>

					<!-- Action Buttons -->
					<div class="flex gap-2 pt-2">
						<button
							id="btn-save-settings"
							class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-semibold transition"
						>
							Save Settings
						</button>
						<button
							id="btn-reset-settings"
							class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded transition"
						>
							Reset
						</button>
					</div>

					<p class="text-xs text-slate-500">
						‚ö†Ô∏è Settings apply to new hands only. Start a new hand after saving.
					</p>
				</div>
			</div>
		</div>

		<!-- Game Info -->
		<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üéØ Game Rules</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Each player gets 2 hole cards</li>
					<li>‚Ä¢ 5 community cards revealed in stages</li>
					<li>‚Ä¢ Make the best 5-card hand</li>
					<li>‚Ä¢ Highest hand wins the pot</li>
				</ul>
			</div>

			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üèÜ Hand Rankings</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Royal Flush</li>
					<li>‚Ä¢ Straight Flush</li>
					<li>‚Ä¢ Four of a Kind</li>
					<li>‚Ä¢ Full House</li>
					<li>‚Ä¢ Flush</li>
				</ul>
			</div>

			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üí∞ Betting</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Minimum bet: $10</li>
					<li>‚Ä¢ Maximum bet: $1,000</li>
					<li>‚Ä¢ Fold to quit round</li>
					<li>‚Ä¢ Check to pass</li>
				</ul>
			</div>
		</div>
	</div>
</CasinoLayout>

<script>
	// Poker game logic
	import { PokerGame } from '../../lib/poker/PokerGame';

	// Initialize game when DOM is loaded
	if (typeof window !== 'undefined') {
		new PokerGame();
	}
</script>

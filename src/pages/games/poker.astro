---
import CasinoLayout from '../../layouts/casino.astro';
import PlayingCard from '../../components/PlayingCard.astro';
import PokerChip from '../../components/PokerChip.astro';

const user = Astro.locals.user;

if (!user) {
	return Astro.redirect('/signin');
}
---

<CasinoLayout title="Texas Hold'em Poker - Arcturus Casino">
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Game Header -->
		<div class="flex items-center justify-between mb-8">
			<div>
				<a
					href="/#games"
					class="text-slate-400 hover:text-yellow-400 transition-colors mb-2 inline-block"
				>
					‚Üê Back to Games
				</a>
				<h1
					class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-500"
				>
					Texas Hold'em Poker
				</h1>
			</div>
			<div class="flex items-center gap-4">
				<div class="bg-slate-800 px-6 py-3 rounded-lg border border-yellow-500/30">
					<div class="text-xs text-slate-400 mb-1">Your Balance</div>
					<div class="text-2xl font-bold text-yellow-400">$1,000</div>
				</div>
			</div>
		</div>

		<!-- Poker Table -->
		<div class="felt-table rounded-3xl p-8 mb-8 relative min-h-[600px]">
			<!-- Pot Display -->
			<div class="absolute top-8 left-1/2 -translate-x-1/2">
				<div
					class="bg-slate-900/80 backdrop-blur-sm px-6 py-3 rounded-full border-2 border-yellow-500/50"
				>
					<div class="text-xs text-slate-400 text-center mb-1">POT</div>
					<div class="text-2xl font-bold text-yellow-400" id="pot-amount">$0</div>
				</div>
			</div>

			<!-- Community Cards -->
			<div class="absolute top-32 left-1/2 -translate-x-1/2">
				<div class="flex gap-3" id="community-cards">
					<div
						class="w-20 h-28 bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-600 flex items-center justify-center text-slate-600"
					>
						?
					</div>
					<div
						class="w-20 h-28 bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-600 flex items-center justify-center text-slate-600"
					>
						?
					</div>
					<div
						class="w-20 h-28 bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-600 flex items-center justify-center text-slate-600"
					>
						?
					</div>
					<div
						class="w-20 h-28 bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-600 flex items-center justify-center text-slate-600"
					>
						?
					</div>
					<div
						class="w-20 h-28 bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-600 flex items-center justify-center text-slate-600"
					>
						?
					</div>
				</div>
			</div>

			<!-- LLM Configuration Overlay -->
			<div
				id="llm-overlay"
				class="hidden absolute inset-0 z-40 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center"
			>
				<div
					class="max-w-md w-full mx-4 bg-slate-900 border border-slate-700 rounded-2xl p-6 shadow-2xl flex flex-col gap-3"
				>
					<div class="flex items-center gap-3">
						<div
							class="h-10 w-10 flex items-center justify-center rounded-xl bg-slate-800 text-yellow-400"
						>
							‚ö†Ô∏è
						</div>
						<div>
							<h2 class="text-lg font-semibold text-white">LLM Poker Rival not configured</h2>
							<p class="text-xs text-slate-400">
								LLM-powered AI is enabled in your game settings, but no API key is configured.
							</p>
						</div>
					</div>
					<p class="text-sm text-slate-300">
						Add an OpenAI or Gemini API key in your profile to unlock AI-powered poker rivals. You
						can also disable the LLM option in Game Settings to play with built-in AI only.
					</p>
					<div class="flex flex-wrap gap-2 mt-2">
						<a
							href="/profile"
							class="inline-flex items-center justify-center gap-2 rounded-lg bg-yellow-500/90 px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-yellow-400 transition"
						>
							Configure API Key
						</a>
						<button
							id="llm-overlay-close"
							type="button"
							class="inline-flex items-center justify-center gap-2 rounded-lg bg-slate-800 px-4 py-2 text-xs font-semibold text-slate-300 hover:bg-slate-700 border border-slate-600 transition"
						>
							Play without LLM
						</button>
					</div>
				</div>
			</div>

			<!-- Opponents (simplified - 3 positions) -->
			<div class="absolute top-8 left-8">
				<div class="bg-slate-900/80 backdrop-blur-sm p-4 rounded-lg border border-slate-700">
					<div class="text-sm text-slate-300 mb-2">Player 2</div>
					<div class="flex gap-2 mb-2" id="opponent1-cards">
						<PlayingCard value="?" suit="spades" faceDown={true} />
						<PlayingCard value="?" suit="spades" faceDown={true} />
					</div>
					<div class="text-xs text-yellow-400">$500</div>
				</div>
			</div>

			<div class="absolute top-8 right-8">
				<div class="bg-slate-900/80 backdrop-blur-sm p-4 rounded-lg border border-slate-700">
					<div class="text-sm text-slate-300 mb-2">Player 3</div>
					<div class="flex gap-2 mb-2" id="opponent2-cards">
						<PlayingCard value="?" suit="spades" faceDown={true} />
						<PlayingCard value="?" suit="spades" faceDown={true} />
					</div>
					<div class="text-xs text-yellow-400">$750</div>
				</div>
			</div>

			<!-- Player's Hand -->
			<div class="absolute bottom-8 left-1/2 -translate-x-1/2">
				<div class="bg-slate-900/90 backdrop-blur-sm p-6 rounded-xl border-2 border-yellow-500/50">
					<div class="text-center mb-4">
						<div class="text-sm text-slate-400 mb-1">Your Hand</div>
						<div class="text-lg font-bold text-yellow-400" id="hand-strength">--</div>
					</div>
					<div class="flex gap-3 justify-center mb-4" id="player-cards">
						<!-- Cards will be inserted here by JavaScript -->
					</div>
					<div class="text-sm text-center text-yellow-400">
						Your Bet: <span id="current-bet">$0</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Game Controls -->
		<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				<!-- Betting Controls -->
				<div>
					<h3 class="text-lg font-bold text-white mb-4">Betting Controls</h3>
					<div class="space-y-3">
						<div class="flex gap-2">
							<button
								id="btn-fold"
								class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
							>
								FOLD
							</button>
							<button
								id="btn-check"
								class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
							>
								CHECK
							</button>
						</div>
						<div class="flex gap-2">
							<button
								id="btn-call"
								class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
							>
								CALL
							</button>
							<button
								id="btn-raise"
								class="flex-1 bg-gradient-to-r from-yellow-600 to-amber-600 hover:from-yellow-700 hover:to-amber-700 text-white py-3 rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
							>
								RAISE
							</button>
						</div>
						<div class="flex gap-2 items-center">
							<input
								type="range"
								id="bet-slider"
								min="10"
								max="1000"
								step="10"
								value="50"
								class="flex-1"
							/>
							<span id="bet-amount" class="text-yellow-400 font-bold min-w-[80px] text-right"
								>$50</span
							>
						</div>
					</div>
				</div>

				<!-- Quick Bet Chips -->
				<div>
					<h3 class="text-lg font-bold text-white mb-4">Quick Bet</h3>
					<div class="grid grid-cols-4 gap-3">
						<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="10">
							<PokerChip value={10} color="red" />
						</button>
						<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="25">
							<PokerChip value={25} color="blue" />
						</button>
						<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="50">
							<PokerChip value={50} color="green" />
						</button>
						<button class="quick-bet-chip hover:scale-110 transition-transform" data-amount="100">
							<PokerChip value={100} color="black" />
						</button>
					</div>
					<button id="btn-deal" class="w-full mt-4 btn-gold py-4 rounded-lg font-bold text-lg">
						DEAL NEW HAND
					</button>
				</div>
			</div>

			<!-- Game Status -->
			<div class="mt-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
				<div class="text-sm text-slate-400 mb-1">Game Status</div>
				<div id="game-status" class="text-lg font-bold text-yellow-400">
					Click "DEAL NEW HAND" to start
				</div>
			</div>

			<div class="mt-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
				<div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
					<div>
						<div class="text-sm text-slate-400 mb-1">AI Rival</div>
						<div id="ai-rival-status" class="text-sm text-slate-300">Loading rival settings‚Ä¶</div>
					</div>
					<button
						id="btn-ai-move"
						class="inline-flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:from-blue-400 hover:to-indigo-500 disabled:cursor-not-allowed disabled:opacity-60"
					>
						Ask AI Rival
					</button>
				</div>
				<p class="mt-3 text-xs text-slate-500">
					Configure API keys in your
					<a href="/profile" class="text-yellow-400 hover:underline">profile settings</a>
					to enable Gemini or OpenAI rivals.
				</p>
			</div>

			<!-- Game Settings -->
			<div class="mt-6 p-4 bg-slate-800 rounded-lg border border-slate-700">
				<div class="flex items-center justify-between mb-3">
					<div class="text-sm text-slate-400">Game Settings</div>
					<button
						id="btn-toggle-settings"
						class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded transition"
					>
						‚öôÔ∏è Configure
					</button>
				</div>

				<!-- Collapsible Settings Panel -->
				<div id="settings-panel" class="hidden mt-4 space-y-4">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<!-- Starting Chips -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Starting Chips</label>
							<input
								type="number"
								id="setting-starting-chips"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
								min="100"
								max="10000"
								step="100"
							/>
						</div>

						<!-- Small Blind -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Small Blind</label>
							<input
								type="number"
								id="setting-small-blind"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
								min="1"
								max="100"
								step="1"
							/>
						</div>

						<!-- Big Blind -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Big Blind</label>
							<input
								type="number"
								id="setting-big-blind"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
								min="2"
								max="200"
								step="1"
							/>
						</div>

						<!-- AI Speed -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">AI Speed</label>
							<select
								id="setting-ai-speed"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							>
								<option value="slow">Slow (1.5-2.5s)</option>
								<option value="normal">Normal (0.8-1.5s)</option>
								<option value="fast">Fast (0.3-0.6s)</option>
							</select>
						</div>

						<!-- AI Player 2 Personality -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Player 2 Style</label>
							<select
								id="setting-ai-personality-1"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							>
								<option value="tight-aggressive">Tight-Aggressive</option>
								<option value="loose-aggressive">Loose-Aggressive</option>
								<option value="tight-passive">Tight-Passive</option>
								<option value="loose-passive">Loose-Passive</option>
							</select>
						</div>

						<!-- AI Player 3 Personality -->
						<div>
							<label class="block text-xs text-slate-400 mb-1">Player 3 Style</label>
							<select
								id="setting-ai-personality-2"
								class="w-full bg-slate-900 text-white px-3 py-2 rounded border border-slate-600 focus:border-yellow-500 focus:outline-none"
							>
								<option value="tight-aggressive">Tight-Aggressive</option>
								<option value="loose-aggressive">Loose-Aggressive</option>
								<option value="tight-passive">Tight-Passive</option>
								<option value="loose-passive">Loose-Passive</option>
							</select>
						</div>
					</div>

					<!-- LLM AI Toggle -->
					<div class="p-4 bg-slate-900 rounded-lg border border-slate-600">
						<div class="flex items-center gap-3">
							<input
								type="checkbox"
								id="setting-use-llm-ai"
								class="w-5 h-5 bg-slate-800 border-slate-600 rounded text-yellow-500 focus:ring-2 focus:ring-yellow-500"
							/>
							<label for="setting-use-llm-ai" class="flex-1">
								<div class="text-sm text-white font-semibold">Use LLM-Powered AI Opponents</div>
								<div class="text-xs text-slate-400 mt-1">
									Enable OpenAI/Gemini for smarter, more human-like AI play. Requires API key
									configured in profile.
								</div>
							</label>
						</div>
					</div>

					<!-- Action Buttons -->
					<div class="flex gap-2 pt-2">
						<button
							id="btn-save-settings"
							class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-semibold transition"
						>
							Save Settings
						</button>
						<button
							id="btn-reset-settings"
							class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded transition"
						>
							Reset
						</button>
					</div>

					<p class="text-xs text-slate-500">
						‚ö†Ô∏è Settings apply to new hands only. Start a new hand after saving.
					</p>
				</div>
			</div>
		</div>

		<!-- Game Info -->
		<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üéØ Game Rules</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Each player gets 2 hole cards</li>
					<li>‚Ä¢ 5 community cards revealed in stages</li>
					<li>‚Ä¢ Make the best 5-card hand</li>
					<li>‚Ä¢ Highest hand wins the pot</li>
				</ul>
			</div>

			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üèÜ Hand Rankings</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Royal Flush</li>
					<li>‚Ä¢ Straight Flush</li>
					<li>‚Ä¢ Four of a Kind</li>
					<li>‚Ä¢ Full House</li>
					<li>‚Ä¢ Flush</li>
				</ul>
			</div>

			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üí∞ Betting</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Minimum bet: $10</li>
					<li>‚Ä¢ Maximum bet: $1,000</li>
					<li>‚Ä¢ Fold to quit round</li>
					<li>‚Ä¢ Check to pass</li>
				</ul>
			</div>
		</div>
	</div>
</CasinoLayout>

<script>
	// Poker game logic
	import { PokerGame } from '../../lib/poker/PokerGame';

	// Initialize game when DOM is loaded
	if (typeof window !== 'undefined') {
		new PokerGame();
	}
</script>

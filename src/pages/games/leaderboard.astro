---
import CasinoLayout from '../../layouts/casino.astro';
import { createDb } from '../../lib/db';
import { getLeaderboardData } from '../../lib/leaderboard/leaderboard';
import type { LeaderboardData } from '../../lib/leaderboard/types';
import {
	getGameLeaderboardData,
	GAME_TYPES,
	RANKING_METRICS,
	GAME_TYPE_LABELS,
	GAME_TYPE_ICONS,
	RANKING_METRIC_LABELS,
	isValidGameType,
	isValidRankingMetric,
	type GameLeaderboardData,
} from '../../lib/game-stats/game-stats';

const session = Astro.locals.session;

// Handle build-time and runtime edge cases (consistent with missions/daily.astro)
if (!session || !Astro.locals.runtime?.env?.DB) {
	if (!session) {
		return Astro.redirect('/signin');
	}
	// During build, return a loading state or error page
	return new Response('Service temporarily unavailable', { status: 503 });
}

const user = session.user;
const dbBinding = Astro.locals.runtime.env.DB;

// Parse query parameters for tab and metric selection
const selectedTab = Astro.url.searchParams.get('game') || 'all';
const selectedMetric = Astro.url.searchParams.get('metric') || 'wins';

// Validate parameters
const isGameTab = selectedTab !== 'all' && isValidGameType(selectedTab);
const validMetric = isValidRankingMetric(selectedMetric) ? selectedMetric : 'wins';

// Fetch leaderboard data server-side
let overallLeaderboardData: LeaderboardData | null = null;
let gameLeaderboardData: GameLeaderboardData | null = null;
let errorMessage: string | null = null;

try {
	const db = createDb(dbBinding);

	if (isGameTab) {
		// Fetch game-specific leaderboard
		gameLeaderboardData = await getGameLeaderboardData(db, {
			gameType: selectedTab as (typeof GAME_TYPES)[number],
			rankingMetric: validMetric as (typeof RANKING_METRICS)[number],
			limit: 50,
			currentUserId: user.id,
		});
	} else {
		// Fetch overall leaderboard (chip balance)
		overallLeaderboardData = await getLeaderboardData(db, {
			limit: 50,
			currentUserId: user.id,
		});
	}
} catch (error) {
	console.error('Leaderboard fetch error:', error);
	errorMessage = 'Failed to load leaderboard. Please try again.';
}

// Format numbers for display (chips, counts, etc.)
function formatNumber(amount: number): string {
	return new Intl.NumberFormat('en-US').format(amount);
}

// Format metric value based on type
function formatMetricValue(value: number, metric: string): string {
	if (metric === 'win_rate') {
		return `${value.toFixed(1)}%`;
	}
	return formatNumber(value);
}

// Tab configuration
const tabs = [
	{ id: 'all', label: 'All Games', icon: 'üèÜ' },
	...GAME_TYPES.map((type) => ({
		id: type,
		label: GAME_TYPE_LABELS[type],
		icon: GAME_TYPE_ICONS[type],
	})),
];

// Get current rank info for display
const currentUserRank = isGameTab
	? gameLeaderboardData?.currentUserRank
	: overallLeaderboardData?.currentUserRank;
const totalPlayers = isGameTab
	? gameLeaderboardData?.totalPlayers
	: overallLeaderboardData?.totalPlayers;
const currentUserInTop = isGameTab
	? gameLeaderboardData?.currentUserInTop
	: overallLeaderboardData?.currentUserInTop;
---

<CasinoLayout title="Leaderboard - Arcturus Casino">
	<section class="relative overflow-hidden">
		<div class="absolute inset-0 pointer-events-none">
			<div class="absolute top-24 -left-20 h-72 w-72 bg-yellow-500/10 rounded-full blur-3xl"></div>
			<div class="absolute bottom-10 right-0 h-64 w-64 bg-amber-500/10 rounded-full blur-3xl"></div>
		</div>

		<div class="relative max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
			<header class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-6">
				<div>
					<a
						href="/"
						class="text-slate-400 hover:text-yellow-400 transition-colors text-sm mb-3 inline-flex items-center gap-1"
					>
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M15 19l-7-7 7-7"></path>
						</svg>
						Back to Lobby
					</a>
					<h1
						class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-amber-500 to-yellow-600 flex items-center gap-3"
					>
						<span class="text-4xl">üèÜ</span>
						<span>Leaderboard</span>
					</h1>
					<p class="mt-2 text-slate-400">
						{
							isGameTab
								? `${GAME_TYPE_LABELS[selectedTab]} rankings`
								: 'Top players ranked by chip balance'
						}
					</p>
				</div>

				{
					currentUserRank && (
						<div class="rounded-2xl border border-yellow-500/20 bg-slate-900/70 px-6 py-4 text-center md:text-right">
							<p class="text-xs uppercase tracking-widest text-yellow-400/60">Your Rank</p>
							<p class="mt-1 text-3xl font-bold text-yellow-400">#{currentUserRank}</p>
							<p class="text-xs text-slate-400 mt-1">
								of {formatNumber(totalPlayers ?? 0)} players
							</p>
						</div>
					)
				}
			</header>

			<!-- Tabs -->
			<div class="flex gap-2 mb-6 overflow-x-auto pb-2" data-testid="leaderboard-tabs">
				{
					tabs.map((tab) => (
						<a
							href={`/games/leaderboard?game=${tab.id}${tab.id !== 'all' ? `&metric=${validMetric}` : ''}`}
							class:list={[
								'px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors flex items-center gap-2',
								selectedTab === tab.id
									? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
									: 'bg-slate-800/50 text-slate-400 border border-slate-700/50 hover:text-yellow-400 hover:border-yellow-500/30',
							]}
							data-testid={`tab-${tab.id}`}
						>
							<span>{tab.icon}</span>
							<span>{tab.label}</span>
						</a>
					))
				}
			</div>

			<!-- Metric selector (only for game tabs) -->
			{
				isGameTab && (
					<div class="flex items-center gap-3 mb-6">
						<span class="text-sm text-slate-400">Rank by:</span>
						<div class="flex gap-2" data-testid="metric-selector">
							{RANKING_METRICS.map((metric) => (
								<a
									href={`/games/leaderboard?game=${selectedTab}&metric=${metric}`}
									class:list={[
										'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors',
										validMetric === metric
											? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
											: 'bg-slate-800/50 text-slate-400 border border-slate-700/50 hover:text-yellow-400',
									]}
									data-testid={`metric-${metric}`}
								>
									{RANKING_METRIC_LABELS[metric]}
								</a>
							))}
						</div>
					</div>
				)
			}

			{
				errorMessage && (
					<div class="rounded-2xl border border-red-500/30 bg-red-900/20 p-8 text-center">
						<p class="text-red-400 text-lg">{errorMessage}</p>
						<button
							onclick="window.location.reload()"
							class="mt-4 px-6 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-300 transition-colors"
						>
							Try Again
						</button>
					</div>
				)
			}

			<!-- Overall Leaderboard Table -->
			{
				!errorMessage &&
					!isGameTab &&
					overallLeaderboardData &&
					overallLeaderboardData.entries.length > 0 && (
						<div class="rounded-2xl border border-yellow-500/20 bg-slate-900/80 shadow-2xl overflow-hidden">
							<div class="overflow-x-auto">
								<table class="w-full" data-testid="leaderboard-table">
									<thead class="bg-slate-800/50 border-b border-yellow-500/20">
										<tr>
											<th class="px-6 py-4 text-left text-xs font-semibold text-yellow-400 uppercase tracking-wider">
												Rank
											</th>
											<th class="px-6 py-4 text-left text-xs font-semibold text-yellow-400 uppercase tracking-wider">
												Player
											</th>
											<th class="px-6 py-4 text-right text-xs font-semibold text-yellow-400 uppercase tracking-wider">
												Chip Balance
											</th>
										</tr>
									</thead>
									<tbody class="divide-y divide-slate-700/50">
										{overallLeaderboardData.entries.map((entry) => {
											const rankEmoji =
												entry.rank === 1
													? 'ü•á'
													: entry.rank === 2
														? 'ü•à'
														: entry.rank === 3
															? 'ü•â'
															: '';

											return (
												<tr
													class:list={[
														'transition-colors',
														entry.isCurrentUser
															? 'bg-yellow-500/10 border-l-4 border-l-yellow-500'
															: 'hover:bg-slate-800/50',
													]}
													data-testid={entry.isCurrentUser ? 'current-user-row' : undefined}
												>
													<td class="px-6 py-4 whitespace-nowrap">
														<span class="text-slate-300 font-semibold flex items-center gap-2">
															{rankEmoji && <span class="text-xl">{rankEmoji}</span>}
															<span>#{entry.rank}</span>
														</span>
													</td>
													<td class="px-6 py-4 whitespace-nowrap">
														<div class="flex items-center gap-3">
															<span
																class:list={[
																	'font-medium',
																	entry.isCurrentUser ? 'text-yellow-400' : 'text-white',
																]}
															>
																{entry.playerName || 'Anonymous'}
															</span>
															{entry.isCurrentUser && (
																<span class="text-xs px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-full font-semibold border border-yellow-500/30">
																	YOU
																</span>
															)}
														</div>
													</td>
													<td class="px-6 py-4 whitespace-nowrap text-right">
														<span
															class:list={[
																'font-bold',
																entry.isCurrentUser ? 'text-yellow-400' : 'text-white',
															]}
														>
															{formatNumber(entry.chipBalance)}
														</span>
														<span class="text-slate-400 text-sm ml-1">chips</span>
													</td>
												</tr>
											);
										})}
									</tbody>
								</table>
							</div>

							{!currentUserInTop && currentUserRank && (
								<div class="bg-slate-800/50 border-t border-yellow-500/20 p-4 text-center">
									<p class="text-slate-300 text-sm">
										You're ranked
										<span class="text-yellow-400 font-bold">#{currentUserRank}</span>. Keep playing
										to reach the top 50!
									</p>
								</div>
							)}
						</div>
					)
			}

			<!-- Game-Specific Leaderboard Table -->
			{
				!errorMessage &&
					isGameTab &&
					gameLeaderboardData &&
					gameLeaderboardData.entries.length > 0 && (
						<div class="rounded-2xl border border-yellow-500/20 bg-slate-900/80 shadow-2xl overflow-hidden">
							<div class="overflow-x-auto">
								<table class="w-full" data-testid="game-leaderboard-table">
									<thead class="bg-slate-800/50 border-b border-yellow-500/20">
										<tr>
											<th class="px-6 py-4 text-left text-xs font-semibold text-yellow-400 uppercase tracking-wider">
												Rank
											</th>
											<th class="px-6 py-4 text-left text-xs font-semibold text-yellow-400 uppercase tracking-wider">
												Player
											</th>
											<th class="px-6 py-4 text-right text-xs font-semibold text-yellow-400 uppercase tracking-wider">
												{RANKING_METRIC_LABELS[validMetric]}
											</th>
											<th class="px-6 py-4 text-right text-xs font-semibold text-yellow-400 uppercase tracking-wider">
												Stats
											</th>
										</tr>
									</thead>
									<tbody class="divide-y divide-slate-700/50">
										{gameLeaderboardData.entries.map((entry) => {
											const rankEmoji =
												entry.rank === 1
													? 'ü•á'
													: entry.rank === 2
														? 'ü•à'
														: entry.rank === 3
															? 'ü•â'
															: '';

											return (
												<tr
													class:list={[
														'transition-colors',
														entry.isCurrentUser
															? 'bg-yellow-500/10 border-l-4 border-l-yellow-500'
															: 'hover:bg-slate-800/50',
													]}
													data-testid={entry.isCurrentUser ? 'current-user-row' : undefined}
												>
													<td class="px-6 py-4 whitespace-nowrap">
														<span class="text-slate-300 font-semibold flex items-center gap-2">
															{rankEmoji && <span class="text-xl">{rankEmoji}</span>}
															<span>#{entry.rank}</span>
														</span>
													</td>
													<td class="px-6 py-4 whitespace-nowrap">
														<div class="flex items-center gap-3">
															<span
																class:list={[
																	'font-medium',
																	entry.isCurrentUser ? 'text-yellow-400' : 'text-white',
																]}
															>
																{entry.playerName || 'Anonymous'}
															</span>
															{entry.isCurrentUser && (
																<span class="text-xs px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-full font-semibold border border-yellow-500/30">
																	YOU
																</span>
															)}
														</div>
													</td>
													<td class="px-6 py-4 whitespace-nowrap text-right">
														<span
															class:list={[
																'font-bold',
																entry.isCurrentUser ? 'text-yellow-400' : 'text-white',
															]}
														>
															{formatMetricValue(entry.metricValue, validMetric)}
														</span>
													</td>
													<td class="px-6 py-4 whitespace-nowrap text-right">
														<div class="text-xs text-slate-400">
															<div>{entry.totalWins} wins</div>
															<div>{entry.handsPlayed} hands</div>
														</div>
													</td>
												</tr>
											);
										})}
									</tbody>
								</table>
							</div>

							{!currentUserInTop && currentUserRank && (
								<div class="bg-slate-800/50 border-t border-yellow-500/20 p-4 text-center">
									<p class="text-slate-300 text-sm">
										You're ranked
										<span class="text-yellow-400 font-bold">#{currentUserRank}</span> in{' '}
										{GAME_TYPE_LABELS[selectedTab]}. Keep playing to reach the top 50!
									</p>
								</div>
							)}
						</div>
					)
			}

			<!-- Empty State -->
			{
				!errorMessage &&
					((isGameTab && gameLeaderboardData?.entries.length === 0) ||
						(!isGameTab && overallLeaderboardData?.entries.length === 0)) && (
						<div class="rounded-2xl border border-slate-700/50 bg-slate-900/50 p-12 text-center">
							<div class="text-6xl mb-4">{isGameTab ? GAME_TYPE_ICONS[selectedTab] : 'üèÜ'}</div>
							<p class="text-slate-400 text-lg">No players found</p>
							<p class="text-slate-500 text-sm mt-2">
								{isGameTab
									? `Be the first to play ${GAME_TYPE_LABELS[selectedTab]} and claim the top spot!`
									: 'Be the first to claim the top spot!'}
							</p>
						</div>
					)
			}

			<div class="mt-8 rounded-2xl border border-yellow-500/20 bg-slate-900/60 p-6">
				<h3 class="text-lg font-bold text-yellow-400 mb-3 flex items-center gap-2">
					<span>üéØ</span>
					<span>How Rankings Work</span>
				</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					{
						isGameTab ? (
							<>
								<li class="flex items-start gap-2">
									<span class="text-yellow-400">‚Ä¢</span>
									<span>
										Game leaderboards track your performance in {GAME_TYPE_LABELS[selectedTab]}
									</span>
								</li>
								<li class="flex items-start gap-2">
									<span class="text-yellow-400">‚Ä¢</span>
									<span>Rank by Total Wins, Win Rate, Biggest Win, or Net Profit</span>
								</li>
								<li class="flex items-start gap-2">
									<span class="text-yellow-400">‚Ä¢</span>
									<span>
										Win Rate requires at least 10 hands played to appear on the leaderboard
									</span>
								</li>
							</>
						) : (
							<>
								<li class="flex items-start gap-2">
									<span class="text-yellow-400">‚Ä¢</span>
									<span>Players are ranked by total chip balance (highest first)</span>
								</li>
								<li class="flex items-start gap-2">
									<span class="text-yellow-400">‚Ä¢</span>
									<span>Only the top 50 players are displayed on this leaderboard</span>
								</li>
								<li class="flex items-start gap-2">
									<span class="text-yellow-400">‚Ä¢</span>
									<span>Earn chips by playing games and completing daily missions</span>
								</li>
							</>
						)
					}
					<li class="flex items-start gap-2">
						<span class="text-yellow-400">‚Ä¢</span>
						<span>Rankings update automatically as you play</span>
					</li>
				</ul>
			</div>
		</div>
	</section>
</CasinoLayout>

---
import CasinoLayout from '../../layouts/casino.astro';
import PokerChip from '../../components/PokerChip.astro';

const user = Astro.locals.user;

if (!user) {
	return Astro.redirect('/signin');
}

// Use nullish coalescing to preserve zero balance (|| would treat 0 as falsy)
const initialBalance = user.chipBalance ?? 1000;
---

<CasinoLayout title="Blackjack - Arcturus Casino">
	<div
		id="blackjack-root"
		data-user-id={user.id}
		class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"
	>
		<!-- Game Header -->
		<div class="flex items-center justify-between mb-8">
			<div>
				<a
					href="/games"
					class="text-slate-400 hover:text-yellow-400 transition-colors mb-2 inline-block"
				>
					‚Üê Back to Games
				</a>
				<h1
					class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-500"
				>
					Blackjack
				</h1>
			</div>
			<div class="flex items-center gap-4">
				<div class="bg-slate-800 px-6 py-3 rounded-lg border border-yellow-500/30">
					<div class="text-xs text-slate-400 mb-1">Your Balance</div>
					<div class="text-2xl font-bold text-yellow-400" id="player-balance">
						${initialBalance.toLocaleString()}
					</div>
				</div>
			</div>
		</div>

		<!-- Blackjack Table -->
		<div class="felt-table rounded-3xl p-8 mb-8 relative" style="min-height: 580px;">
			<!-- Game Status Message - centered in table -->
			<div
				class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center z-10 pointer-events-none"
			>
				<div
					id="game-status"
					class="text-lg font-semibold text-yellow-400 bg-slate-900/90 backdrop-blur-sm px-8 py-3 rounded-full border-2 border-yellow-500/50 shadow-lg"
				>
					Place your bet to start
				</div>
			</div>

			<!-- Dealer Area - positioned in top third -->
			<div class="absolute top-14 left-1/2 -translate-x-1/2 w-full max-w-2xl px-4">
				<div class="bg-slate-900/60 backdrop-blur-sm p-3 rounded-2xl border border-slate-700/50">
					<div class="text-center mb-1">
						<div class="text-xs text-slate-400 uppercase tracking-wider">Dealer</div>
						<div
							id="dealer-value"
							class="inline-block text-lg font-bold text-white bg-slate-800 px-3 py-0.5 rounded-full"
						>
							?
						</div>
					</div>
					<div id="dealer-cards" class="flex justify-center gap-2 min-h-[90px] items-center">
						<!-- Dealer cards will be rendered here -->
						<div class="card-placeholder"></div>
						<div class="card-placeholder"></div>
					</div>
				</div>
			</div>

			<!-- Player Area - positioned in bottom third -->
			<div class="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-2xl px-4">
				<div class="bg-slate-900/60 backdrop-blur-sm p-3 rounded-2xl border-2 border-yellow-500/30">
					<div class="text-center mb-1">
						<div class="text-xs text-slate-400 uppercase tracking-wider">Your Hand</div>
						<div id="player-value" class="text-xl font-bold text-yellow-400">-</div>
					</div>
					<div
						id="player-cards"
						class="flex justify-center gap-2 min-h-[90px] items-center flex-wrap"
					>
						<!-- Player cards will be rendered here -->
						<div class="card-placeholder"></div>
						<div class="card-placeholder"></div>
					</div>
					<div class="text-center mt-1">
						<div id="current-bet" class="text-sm text-yellow-400/80 font-medium">
							Current Bet: $0
						</div>
					</div>
				</div>
			</div>

			<!-- AI Commentary Box (shown after round) -->
			<div
				id="ai-commentary-box"
				class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900/95 backdrop-blur-sm rounded-2xl p-6 border border-cyan-500/50 max-w-sm text-center z-20 shadow-2xl"
			>
				<div class="text-4xl mb-3">üé∞</div>
				<div id="ai-commentary-text" class="text-lg text-slate-200"></div>
			</div>
		</div>

		<!-- Game Controls Section -->
		<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
			<div class="max-w-md mx-auto">
				<!-- Betting Controls -->
				<div id="betting-controls">
					<h3 class="text-lg font-bold text-white mb-4 text-center">Place Your Bet</h3>
					<div class="space-y-4">
						<div>
							<label for="bet-amount" class="block text-sm text-slate-400 mb-2">Bet Amount</label>
							<input
								type="number"
								id="bet-amount"
								min="10"
								max="500"
								value="50"
								step="10"
								class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white text-lg focus:border-yellow-500 focus:outline-none focus:ring-2 focus:ring-yellow-500/20"
							/>
						</div>
						<div class="grid grid-cols-4 gap-3">
							<button
								class="bet-quick hover:scale-110 transition-transform flex flex-col items-center"
								data-amount="25"
							>
								<PokerChip value={25} color="red" />
							</button>
							<button
								class="bet-quick hover:scale-110 transition-transform flex flex-col items-center"
								data-amount="50"
							>
								<PokerChip value={50} color="blue" />
							</button>
							<button
								class="bet-quick hover:scale-110 transition-transform flex flex-col items-center"
								data-amount="100"
							>
								<PokerChip value={100} color="green" />
							</button>
							<button
								class="bet-quick hover:scale-110 transition-transform flex flex-col items-center"
								data-amount="200"
							>
								<PokerChip value={200} color="black" />
							</button>
						</div>
						<button id="btn-deal" class="w-full btn-gold py-4 rounded-lg font-bold text-lg">
							DEAL CARDS
						</button>
					</div>
				</div>

				<!-- Game Controls (Hidden Initially) -->
				<div id="game-controls" class="hidden">
					<h3 class="text-lg font-bold text-white mb-4 text-center">Your Move</h3>
					<div class="space-y-3">
						<div class="grid grid-cols-2 gap-3">
							<button
								id="btn-hit"
								class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
							>
								<span class="text-xl">üëÜ</span>
								<span>HIT</span>
							</button>
							<button
								id="btn-stand"
								class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
							>
								<span class="text-xl">‚úã</span>
								<span>STAND</span>
							</button>
							<button
								id="btn-double"
								class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
								title="Double your bet and receive one card"
							>
								<span class="text-xl">üí∞</span>
								<span>DOUBLE</span>
							</button>
							<button
								id="btn-split"
								class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
								title="Split your pair into two hands"
							>
								<span class="text-xl">‚úåÔ∏è</span>
								<span>SPLIT</span>
							</button>
						</div>

						<button
							id="btn-new-round"
							class="hidden w-full btn-gold py-4 rounded-lg font-bold text-lg mt-4"
						>
							NEW ROUND
						</button>
					</div>
				</div>
			</div>

			<!-- AI Rival Panel -->
			<div class="max-w-2xl mx-auto mt-6">
				<div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
					<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
						<div>
							<div class="text-sm text-slate-400 mb-1">AI Strategy Advisor</div>
							<div id="ai-rival-status" class="text-sm text-slate-300">
								Configure API keys in profile to enable
							</div>
						</div>
						<button
							id="btn-ai-rival"
							class="inline-flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-cyan-500 to-teal-600 hover:from-cyan-600 hover:to-teal-700 px-5 py-3 text-sm font-semibold text-white transition disabled:cursor-not-allowed disabled:opacity-60"
							title="Get AI strategy advice"
						>
							<span>ü§ñ</span>
							<span id="btn-ai-rival-text">Ask AI Rival</span>
						</button>
					</div>
					<div
						id="ai-advice-box"
						class="hidden mt-4 p-4 bg-slate-900/80 rounded-lg border border-cyan-500/30"
					>
						<div class="flex items-start gap-3">
							<span class="text-2xl">üí°</span>
							<div>
								<div id="ai-advice-action" class="font-bold text-cyan-400 text-lg mb-1"></div>
								<div id="ai-advice-reasoning" class="text-sm text-slate-300"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Game Info -->
		<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üéØ Game Rules</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Beat the dealer by getting closer to 21</li>
					<li>‚Ä¢ Face cards are worth 10</li>
					<li>‚Ä¢ Aces are worth 1 or 11</li>
					<li>‚Ä¢ Going over 21 means you bust</li>
				</ul>
			</div>

			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üÉè Actions</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ <span class="text-blue-400">Hit</span> - Take another card</li>
					<li>‚Ä¢ <span class="text-green-400">Stand</span> - Keep your hand</li>
					<li>‚Ä¢ <span class="text-purple-400">Double</span> - Double bet, one card</li>
					<li>‚Ä¢ <span class="text-orange-400">Split</span> - Split matching cards</li>
				</ul>
			</div>

			<div class="bg-slate-900 rounded-xl p-6 border border-slate-700">
				<h3 class="text-xl font-bold text-yellow-400 mb-4">üí∞ Payouts</h3>
				<ul class="space-y-2 text-sm text-slate-300">
					<li>‚Ä¢ Blackjack pays 3:2</li>
					<li>‚Ä¢ Regular win pays 1:1</li>
					<li>‚Ä¢ Push returns your bet</li>
					<li>‚Ä¢ Insurance pays 2:1</li>
				</ul>
			</div>
		</div>

		<!-- LLM Configuration Overlay -->
		<div
			id="llm-config-overlay"
			class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center"
		>
			<div class="bg-slate-900 rounded-2xl p-8 max-w-md mx-4 border border-slate-700 shadow-2xl">
				<div class="text-center mb-6">
					<div class="text-5xl mb-4">ü§ñ</div>
					<h2 class="text-2xl font-bold text-white mb-2">AI Rival Not Configured</h2>
					<p class="text-slate-400">
						To get AI-powered strategy advice, you need to configure your API key in your profile
						settings.
					</p>
				</div>
				<div class="space-y-3">
					<a
						href="/profile"
						class="block w-full bg-gradient-to-r from-cyan-500 to-teal-600 hover:from-cyan-600 hover:to-teal-700 text-white font-bold py-3 px-6 rounded-lg text-center transition-all"
					>
						Configure API Key
					</a>
					<button
						id="btn-close-overlay"
						class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 px-6 rounded-lg transition-colors border border-slate-600"
					>
						Play Without AI
					</button>
				</div>
			</div>
		</div>
	</div>
</CasinoLayout>

<style>
	.felt-table {
		background:
			radial-gradient(ellipse at center, #1e7b4e 0%, #165c3a 70%, #0f4028 100%),
			url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
		box-shadow:
			inset 0 0 100px rgba(0, 0, 0, 0.3),
			inset 0 2px 4px rgba(0, 0, 0, 0.3),
			0 10px 40px rgba(0, 0, 0, 0.4);
		border: 8px solid #2a1810;
		outline: 4px solid #1a0f08;
	}

	.btn-gold {
		background: linear-gradient(180deg, #fbbf24 0%, #d97706 100%);
		color: #1e293b;
		box-shadow:
			0 4px 14px rgba(251, 191, 36, 0.4),
			inset 0 1px 0 rgba(255, 255, 255, 0.3);
		transition: all 0.2s ease;
	}

	.btn-gold:hover {
		background: linear-gradient(180deg, #fcd34d 0%, #f59e0b 100%);
		transform: translateY(-2px);
		box-shadow:
			0 6px 20px rgba(251, 191, 36, 0.5),
			inset 0 1px 0 rgba(255, 255, 255, 0.4);
	}

	.card-placeholder {
		width: 70px;
		height: 98px;
		background: rgba(255, 255, 255, 0.1);
		border-radius: 8px;
		border: 2px dashed rgba(255, 255, 255, 0.2);
	}

	/* Playing card styles - matches poker.astro PlayingCard component */
	:global(.playing-card) {
		width: 60px;
		height: 84px;
		background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
		border-radius: 8px;
		display: flex;
		flex-direction: column;
		position: relative;
		box-shadow:
			0 4px 12px rgba(0, 0, 0, 0.3),
			0 0 0 1px rgba(0, 0, 0, 0.1),
			inset 0 1px 0 rgba(255, 255, 255, 0.8);
		animation: card-deal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
		transition: transform 0.2s ease;
	}

	:global(.playing-card:hover) {
		transform: translateY(-4px);
	}

	:global(.playing-card-inner) {
		width: 100%;
		height: 100%;
		padding: 6px;
		display: flex;
		flex-direction: column;
	}

	:global(.playing-card .card-corner) {
		display: flex;
		flex-direction: column;
		align-items: center;
		line-height: 1;
	}

	:global(.playing-card .card-corner-top) {
		align-self: flex-start;
	}

	:global(.playing-card .card-corner-bottom) {
		align-self: flex-end;
		transform: rotate(180deg);
		margin-top: auto;
	}

	:global(.playing-card .card-rank) {
		font-size: 14px;
		font-weight: 700;
	}

	:global(.playing-card .card-suit-small) {
		font-size: 10px;
		margin-top: -2px;
	}

	:global(.playing-card .card-suit-center) {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		font-size: 28px;
	}

	:global(.playing-card.card-red) {
		color: #dc2626;
	}

	:global(.playing-card.card-black) {
		color: #1e293b;
	}

	:global(.playing-card-back) {
		width: 60px;
		height: 84px;
		background: linear-gradient(135deg, #1e40af 0%, #3730a3 50%, #1e3a8a 100%);
		border-radius: 8px;
		display: flex;
		align-items: center;
		justify-content: center;
		box-shadow:
			0 4px 12px rgba(0, 0, 0, 0.3),
			0 0 0 1px rgba(0, 0, 0, 0.1),
			inset 0 1px 0 rgba(255, 255, 255, 0.2);
		animation: card-deal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
		position: relative;
		overflow: hidden;
	}

	:global(.playing-card-back::before) {
		content: '';
		position: absolute;
		inset: 6px;
		border: 2px solid rgba(255, 255, 255, 0.3);
		border-radius: 6px;
		background: repeating-linear-gradient(
			45deg,
			transparent,
			transparent 4px,
			rgba(255, 255, 255, 0.05) 4px,
			rgba(255, 255, 255, 0.05) 8px
		);
	}

	:global(.playing-card-back .card-back-icon) {
		font-size: 24px;
		color: rgba(255, 255, 255, 0.9);
		z-index: 1;
	}

	/* Split hand indicator */
	:global(.hand-container) {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 8px;
		padding: 12px;
		border-radius: 12px;
		transition: all 0.2s ease;
	}

	:global(.hand-container.active-hand) {
		border: 2px solid #fbbf24;
		background: rgba(251, 191, 36, 0.1);
	}

	:global(.hand-container.inactive-hand) {
		border: 2px solid rgba(148, 163, 184, 0.3);
		opacity: 0.7;
	}

	:global(.hand-label) {
		font-size: 12px;
		color: #94a3b8;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	:global(.hand-cards) {
		display: flex;
		gap: 8px;
	}

	:global(.hand-value) {
		font-size: 16px;
		font-weight: 700;
		color: white;
	}

	@keyframes card-deal {
		from {
			opacity: 0;
			transform: translateY(-30px) rotateX(-20deg) scale(0.8);
		}
		to {
			opacity: 1;
			transform: translateY(0) rotateX(0) scale(1);
		}
	}

	/* Chip stack styling */
	:global(.poker-chip) {
		width: 48px;
		height: 48px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		border-width: 4px;
		border-style: dashed;
		font-weight: bold;
		box-shadow:
			0 3px 6px rgba(0, 0, 0, 0.3),
			inset 0 2px 4px rgba(255, 255, 255, 0.2);
		transition: transform 0.15s ease;
	}

	:global(.chip-stack) {
		cursor: pointer;
	}

	:global(.chip-stack:hover) {
		transform: scale(1.1);
	}
</style>

<script>
	import { initBlackjackClient } from '../../lib/blackjack/blackjackClient';

	initBlackjackClient();
</script>

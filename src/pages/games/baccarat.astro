---
import CasinoLayout from '../../layouts/casino.astro';
import PokerChip from '../../components/PokerChip.astro';

const user = Astro.locals.user;

if (!user) {
	return Astro.redirect('/signin');
}

// Use nullish coalescing to preserve zero balance
const initialBalance = user.chipBalance ?? 1000;
---

<CasinoLayout title="Baccarat - Arcturus Casino">
	<div
		id="baccarat-root"
		data-user-id={user.id}
		data-initial-balance={initialBalance}
		class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"
	>
		<!-- Game Header -->
		<div class="flex items-center justify-between mb-6">
			<div>
				<a
					href="/games"
					class="text-slate-400 hover:text-yellow-400 transition-colors mb-2 inline-block"
				>
					‚Üê Back to Games
				</a>
				<h1
					class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-500"
				>
					Baccarat
				</h1>
			</div>
			<div class="flex items-center gap-4">
				<div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-600 text-sm">
					<span class="text-slate-400">Shoe:</span>
					<span id="shoe-count" class="text-white ml-1">416 cards</span>
				</div>
				<div class="bg-slate-800 px-6 py-3 rounded-lg border border-yellow-500/30">
					<div class="text-xs text-slate-400 mb-1">Your Balance</div>
					<div class="text-2xl font-bold text-yellow-400" id="chip-balance">
						${initialBalance.toLocaleString()}
					</div>
				</div>
			</div>
		</div>

		<!-- Main Game Area -->
		<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
			<!-- Game Table (3 columns) -->
			<div class="lg:col-span-3">
				<!-- Baccarat Table -->
				<div class="felt-table rounded-3xl p-6 mb-6 relative" style="min-height: 420px;">
					<!-- Game Status Message -->
					<div
						id="game-status"
						class="hidden absolute top-4 left-1/2 -translate-x-1/2 text-lg font-semibold text-yellow-400 bg-slate-900/90 backdrop-blur-sm px-6 py-2 rounded-full border border-yellow-500/50 z-10"
					>
						Place your bets
					</div>

					<!-- Banker Area -->
					<div id="banker-hand" class="mb-8">
						<div class="text-center">
							<div class="text-sm text-red-400 uppercase tracking-wider mb-2 font-semibold">
								Banker
							</div>
							<div class="flex justify-center gap-3 min-h-[100px] items-center">
								<div class="card-placeholder"></div>
								<div class="card-placeholder"></div>
							</div>
							<div class="hand-value text-xl font-bold text-white mt-2"></div>
						</div>
					</div>

					<!-- Divider -->
					<div class="border-t border-slate-600/50 my-6"></div>

					<!-- Player Area -->
					<div id="player-hand" class="mb-6">
						<div class="text-center">
							<div class="text-sm text-blue-400 uppercase tracking-wider mb-2 font-semibold">
								Player
							</div>
							<div class="flex justify-center gap-3 min-h-[100px] items-center">
								<div class="card-placeholder"></div>
								<div class="card-placeholder"></div>
							</div>
							<div class="hand-value text-xl font-bold text-white mt-2"></div>
						</div>
					</div>

					<!-- Round Result Overlay -->
					<div
						id="round-result"
						class="hidden absolute inset-0 bg-slate-900/95 backdrop-blur-sm rounded-3xl flex items-center justify-center z-20"
					>
						<div class="text-center p-8">
							<div class="result-winner text-4xl font-bold text-yellow-400 mb-4"></div>
							<div class="result-scores text-xl text-slate-300 mb-4"></div>
							<div class="result-pairs text-lg text-green-400 mb-4"></div>
							<div class="result-bets space-y-2 mb-6"></div>
							<button id="new-round-button" class="btn-gold px-8 py-3 rounded-lg font-bold text-lg">
								NEW ROUND
							</button>
						</div>
					</div>
				</div>

				<!-- Betting Area -->
				<div id="betting-area" class="bg-slate-900 rounded-xl p-6 border border-slate-700">
					<h3 class="text-lg font-bold text-white mb-4 text-center">Place Your Bets</h3>

					<!-- Main Bets -->
					<div class="grid grid-cols-3 gap-4 mb-4">
						<!-- Player Bet -->
						<div
							data-bet-type="player"
							class="bet-area bg-blue-900/30 hover:bg-blue-900/50 border-2 border-blue-500/30 hover:border-blue-500 rounded-xl p-4 cursor-pointer transition-all text-center"
						>
							<div class="text-blue-400 font-bold text-lg mb-1">PLAYER</div>
							<div class="text-slate-400 text-sm">Pays 1:1</div>
							<div class="bet-amount text-yellow-400 font-bold mt-2 h-6"></div>
						</div>

						<!-- Tie Bet -->
						<div
							data-bet-type="tie"
							class="bet-area bg-green-900/30 hover:bg-green-900/50 border-2 border-green-500/30 hover:border-green-500 rounded-xl p-4 cursor-pointer transition-all text-center"
						>
							<div class="text-green-400 font-bold text-lg mb-1">TIE</div>
							<div class="text-slate-400 text-sm">Pays 8:1</div>
							<div class="bet-amount text-yellow-400 font-bold mt-2 h-6"></div>
						</div>

						<!-- Banker Bet -->
						<div
							data-bet-type="banker"
							class="bet-area bg-red-900/30 hover:bg-red-900/50 border-2 border-red-500/30 hover:border-red-500 rounded-xl p-4 cursor-pointer transition-all text-center"
						>
							<div class="text-red-400 font-bold text-lg mb-1">BANKER</div>
							<div class="text-slate-400 text-sm">Pays 0.95:1</div>
							<div class="bet-amount text-yellow-400 font-bold mt-2 h-6"></div>
						</div>
					</div>

					<!-- Side Bets -->
					<div class="grid grid-cols-2 gap-4 mb-6">
						<!-- Player Pair -->
						<div
							data-bet-type="playerPair"
							class="bet-area bg-purple-900/30 hover:bg-purple-900/50 border-2 border-purple-500/30 hover:border-purple-500 rounded-xl p-3 cursor-pointer transition-all text-center"
						>
							<div class="text-purple-400 font-bold mb-1">PLAYER PAIR</div>
							<div class="text-slate-400 text-xs">Pays 11:1</div>
							<div class="bet-amount text-yellow-400 font-bold mt-1 h-5 text-sm"></div>
						</div>

						<!-- Banker Pair -->
						<div
							data-bet-type="bankerPair"
							class="bet-area bg-purple-900/30 hover:bg-purple-900/50 border-2 border-purple-500/30 hover:border-purple-500 rounded-xl p-3 cursor-pointer transition-all text-center"
						>
							<div class="text-purple-400 font-bold mb-1">BANKER PAIR</div>
							<div class="text-slate-400 text-xs">Pays 11:1</div>
							<div class="bet-amount text-yellow-400 font-bold mt-1 h-5 text-sm"></div>
						</div>
					</div>

					<!-- Chip Selection -->
					<div class="flex justify-center gap-3 mb-4">
						<button class="chip-select hover:scale-110 transition-transform" data-amount="10">
							<PokerChip value={10} color="gold" />
						</button>
						<button class="chip-select hover:scale-110 transition-transform" data-amount="25">
							<PokerChip value={25} color="red" />
						</button>
						<button class="chip-select hover:scale-110 transition-transform" data-amount="50">
							<PokerChip value={50} color="blue" />
						</button>
						<button class="chip-select hover:scale-110 transition-transform" data-amount="100">
							<PokerChip value={100} color="green" />
						</button>
						<button class="chip-select hover:scale-110 transition-transform" data-amount="500">
							<PokerChip value={500} color="black" />
						</button>
					</div>

					<!-- Total Bet & Actions -->
					<div class="flex items-center justify-between">
						<div>
							<span class="text-slate-400">Total Bet:</span>
							<span id="total-bet" class="text-yellow-400 font-bold ml-2">$0</span>
						</div>
						<div class="flex gap-3">
							<button
								id="clear-bets-button"
								class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
							>
								Clear
							</button>
							<button
								id="deal-button"
								disabled
								class="btn-gold px-8 py-2 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed"
							>
								DEAL
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Sidebar (1 column) -->
			<div class="space-y-6">
				<!-- Scoreboard -->
				<div class="bg-slate-900 rounded-xl p-4 border border-slate-700">
					<h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">History</h3>
					<div id="scoreboard" class="flex flex-wrap gap-1 min-h-[60px]">
						<span class="text-neutral-500">No history yet</span>
					</div>
					<div class="mt-3 pt-3 border-t border-slate-700">
						<div class="grid grid-cols-3 gap-2 text-center text-xs">
							<div>
								<div class="text-blue-400 font-bold" id="stat-player">0%</div>
								<div class="text-slate-500">Player</div>
							</div>
							<div>
								<div class="text-green-400 font-bold" id="stat-tie">0%</div>
								<div class="text-slate-500">Tie</div>
							</div>
							<div>
								<div class="text-red-400 font-bold" id="stat-banker">0%</div>
								<div class="text-slate-500">Banker</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Active Bets -->
				<div class="bg-slate-900 rounded-xl p-4 border border-slate-700">
					<h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Your Bets</h3>
					<div id="active-bets" class="space-y-2 min-h-[40px]">
						<span class="text-neutral-500">No bets placed</span>
					</div>
				</div>

				<!-- Payouts Reference -->
				<div class="bg-slate-900 rounded-xl p-4 border border-slate-700">
					<h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Payouts</h3>
					<div class="space-y-2 text-sm">
						<div class="flex justify-between">
							<span class="text-blue-400">Player</span>
							<span class="text-slate-300">1:1</span>
						</div>
						<div class="flex justify-between">
							<span class="text-red-400">Banker</span>
							<span class="text-slate-300">0.95:1</span>
						</div>
						<div class="flex justify-between">
							<span class="text-green-400">Tie</span>
							<span class="text-slate-300">8:1</span>
						</div>
						<div class="flex justify-between">
							<span class="text-purple-400">Pairs</span>
							<span class="text-slate-300">11:1</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Insufficient Chips Overlay -->
		<div
			id="insufficient-chips-overlay"
			class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-50 flex items-center justify-center"
		>
			<div class="bg-slate-800 rounded-xl p-8 border border-red-500/50 max-w-md text-center">
				<div class="text-5xl mb-4">üí∏</div>
				<h2 class="text-2xl font-bold text-white mb-2">Insufficient Chips</h2>
				<p class="text-slate-400 mb-6">You don't have enough chips to continue playing.</p>
				<a href="/games" class="btn-gold px-8 py-3 rounded-lg font-bold inline-block">
					Return to Lobby
				</a>
			</div>
		</div>
	</div>
</CasinoLayout>

<style>
	.felt-table {
		background: linear-gradient(135deg, #0d4a35 0%, #0a3829 50%, #073020 100%);
		box-shadow:
			inset 0 0 100px rgba(0, 0, 0, 0.3),
			0 10px 40px rgba(0, 0, 0, 0.5);
	}

	.card-placeholder {
		width: 60px;
		height: 84px;
		background: rgba(255, 255, 255, 0.05);
		border: 2px dashed rgba(255, 255, 255, 0.1);
		border-radius: 8px;
	}

	.hand-cards .card {
		width: 60px;
		height: 84px;
		background: white;
		border-radius: 8px;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		font-size: 1.25rem;
		font-weight: bold;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		animation: dealCard 0.3s ease-out;
	}

	@keyframes dealCard {
		from {
			opacity: 0;
			transform: translateY(-20px) scale(0.8);
		}
		to {
			opacity: 1;
			transform: translateY(0) scale(1);
		}
	}

	.card-dealing {
		animation: dealCard 0.3s ease-out;
	}

	.bet-area {
		transition: all 0.2s ease;
	}

	.bet-area:hover {
		transform: translateY(-2px);
	}

	.bet-area-active {
		border-color: rgba(234, 179, 8, 0.8) !important;
		box-shadow: 0 0 20px rgba(234, 179, 8, 0.3);
	}

	.betting-disabled {
		opacity: 0.5;
		pointer-events: none;
	}

	.scoreboard-dot {
		width: 24px;
		height: 24px;
		border-radius: 50%;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-size: 10px;
		font-weight: bold;
		color: white;
	}

	.bet-chip {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		background: rgba(234, 179, 8, 0.1);
		border: 1px solid rgba(234, 179, 8, 0.3);
		padding: 4px 12px;
		border-radius: 20px;
	}

	.bet-result {
		display: flex;
		justify-content: space-between;
		gap: 16px;
		padding: 8px 16px;
		background: rgba(255, 255, 255, 0.05);
		border-radius: 8px;
	}

	.chip-select {
		transition: transform 0.2s ease;
	}

	.chip-select.selected {
		transform: scale(1.2);
		filter: drop-shadow(0 0 10px rgba(234, 179, 8, 0.5));
	}
</style>

<script type="module">
	import { BaccaratGame } from '../../lib/baccarat/BaccaratGame';
	import { getHandValue } from '../../lib/baccarat/handEvaluator';

	// Get initial data
	const root = document.getElementById('baccarat-root');
	if (!root) {
		throw new Error('Baccarat root element not found');
	}
	const initialBalance = Number(root.dataset.initialBalance ?? 1000);

	// Initialize game
	const game = new BaccaratGame({
		initialBalance,
		settings: {
			minBet: 10,
			maxBet: 5000,
			startingChips: initialBalance,
			animationSpeed: 'normal',
			llmEnabled: false,
			soundEnabled: true,
		},
	});

	// State
	let selectedChipAmount = 50;

	// DOM Elements
	const balanceEl = document.getElementById('chip-balance');
	const shoeCountEl = document.getElementById('shoe-count');
	const totalBetEl = document.getElementById('total-bet');
	const dealButton = document.getElementById('deal-button');
	const clearBetsButton = document.getElementById('clear-bets-button');
	const newRoundButton = document.getElementById('new-round-button');
	const playerHandEl = document.getElementById('player-hand');
	const bankerHandEl = document.getElementById('banker-hand');
	const roundResultEl = document.getElementById('round-result');
	const bettingAreaEl = document.getElementById('betting-area');
	const activeBetsEl = document.getElementById('active-bets');
	const scoreboardEl = document.getElementById('scoreboard');
	const insufficientOverlay = document.getElementById('insufficient-chips-overlay');
	const statusEl = document.getElementById('game-status');

	if (
		!balanceEl ||
		!shoeCountEl ||
		!totalBetEl ||
		!(dealButton instanceof HTMLButtonElement) ||
		!clearBetsButton ||
		!newRoundButton ||
		!playerHandEl ||
		!bankerHandEl ||
		!roundResultEl ||
		!bettingAreaEl ||
		!activeBetsEl ||
		!scoreboardEl ||
		!insufficientOverlay ||
		!statusEl
	) {
		throw new Error('Baccarat UI elements not found');
	}

	// Chip selection
	document.querySelectorAll('.chip-select').forEach((btn) => {
		btn.addEventListener('click', () => {
			document.querySelectorAll('.chip-select').forEach((b) => b.classList.remove('selected'));
			btn.classList.add('selected');
			const amountAttr = btn.getAttribute('data-amount');
			if (amountAttr) {
				selectedChipAmount = Number(amountAttr);
			}
		});
	});

	// Select default chip
	document.querySelector('.chip-select[data-amount="50"]')?.classList.add('selected');

	// Bet area clicks
	document.querySelectorAll('[data-bet-type]').forEach((area) => {
		area.addEventListener('click', () => {
			const type = area.getAttribute('data-bet-type');
			if (!type) return;
			const result = game.placeBet(type, selectedChipAmount);
			if (result.success) {
				updateUI();
			} else {
				showStatus(result.error ?? 'Failed to place bet');
			}
		});
	});

	// Clear bets
	clearBetsButton.addEventListener('click', () => {
		game.clearBets();
		updateUI();
	});

	// Deal
	dealButton.addEventListener('click', async () => {
		if (!game.canDeal()) return;

		// Disable betting
		bettingAreaEl.classList.add('betting-disabled');
		dealButton.disabled = true;
		roundResultEl.classList.add('hidden');

		// Clear hand displays
		renderHand(playerHandEl, { cards: [] }, 'PLAYER', 'blue');
		renderHand(bankerHandEl, { cards: [] }, 'BANKER', 'red');

		showStatus('Dealing...');

		// Deal and animate
		const outcome = game.deal();
		if (outcome) {
			await animateRound(outcome);
			showResult(outcome);
			await syncBalance();

			// Check insufficient chips
			if (game.hasInsufficientChips()) {
				insufficientOverlay.classList.remove('hidden');
			}
		}

		updateUI();
	});

	// New round
	newRoundButton.addEventListener('click', () => {
		game.newRound();
		roundResultEl.classList.add('hidden');
		bettingAreaEl.classList.remove('betting-disabled');
		renderHand(playerHandEl, { cards: [] }, 'PLAYER', 'blue');
		renderHand(bankerHandEl, { cards: [] }, 'BANKER', 'red');
		hideStatus();
		updateUI();
	});

	// Animation helpers
	async function animateRound(outcome) {
		const delay = (ms) => new Promise((r) => setTimeout(r, ms));

		// Deal initial 4 cards with animation
		await animateCard(playerHandEl, outcome.playerHand.cards[0], 0);
		await delay(300);
		await animateCard(bankerHandEl, outcome.bankerHand.cards[0], 0);
		await delay(300);
		await animateCard(playerHandEl, outcome.playerHand.cards[1], 1);
		await delay(300);
		await animateCard(bankerHandEl, outcome.bankerHand.cards[1], 1);
		await delay(500);

		// Third cards if present
		if (outcome.playerHand.cards.length > 2) {
			showStatus('Player draws third card');
			await delay(500);
			await animateCard(playerHandEl, outcome.playerHand.cards[2], 2);
			await delay(500);
		}

		if (outcome.bankerHand.cards.length > 2) {
			showStatus('Banker draws third card');
			await delay(500);
			await animateCard(bankerHandEl, outcome.bankerHand.cards[2], 2);
			await delay(500);
		}

		hideStatus();
	}

	async function animateCard(container, card, _position) {
		const cardsContainer = container.querySelector('.hand-cards') || container;

		// Remove placeholders
		cardsContainer.querySelectorAll('.card-placeholder').forEach((p) => p.remove());

		const cardEl = document.createElement('div');
		cardEl.className = 'card card-dealing';
		const suitSymbol =
			{ hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' }[card.suit] || card.suit;
		const suitColor =
			card.suit === 'hearts' || card.suit === 'diamonds' ? 'text-red-500' : 'text-neutral-900';
		cardEl.innerHTML = `
			<span class="card-rank">${card.rank}</span>
			<span class="card-suit ${suitColor}">${suitSymbol}</span>
		`;
		cardsContainer.appendChild(cardEl);

		// Update hand value
		const allCards = Array.from(cardsContainer.querySelectorAll('.card')).map((el) => {
			const rankEl = el.querySelector('.card-rank');
			return {
				rank: rankEl ? rankEl.textContent : '',
				suit: 'hearts', // suit doesn't affect value in baccarat
			};
		});

		// Just show card count for now, real value calculated from outcome
		const valueEl = container.querySelector('.hand-value');
		if (valueEl && allCards.length >= 2) {
			// We'll update this properly after animation
		}

		await new Promise((r) => setTimeout(r, 300));
	}

	function renderHand(container, hand, label, color) {
		const colorClassMap = {
			blue: 'text-blue-400',
			red: 'text-red-400',
			emerald: 'text-emerald-400',
			yellow: 'text-yellow-400',
		};
		const colorClass = colorClassMap[color] ?? 'text-blue-400';

		const value = hand.cards.length >= 2 ? getHandValue(hand) : '';
		const cardsHTML =
			hand.cards.length > 0
				? hand.cards
						.map((card) => {
							const suitSymbol =
								{ hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' }[card.suit] || card.suit;
							const suitColor =
								card.suit === 'hearts' || card.suit === 'diamonds'
									? 'text-red-500'
									: 'text-neutral-900';
							return `
							<div class="card">
								<span class="card-rank">${card.rank}</span>
								<span class="card-suit ${suitColor}">${suitSymbol}</span>
							</div>
						`;
						})
						.join('')
				: '<div class="card-placeholder"></div><div class="card-placeholder"></div>';

		container.innerHTML = `
			<div class="text-center">
				<div class="text-sm ${colorClass} uppercase tracking-wider mb-2 font-semibold">${label}</div>
				<div class="hand-cards flex justify-center gap-3 min-h-[100px] items-center">${cardsHTML}</div>
				<div class="hand-value text-xl font-bold text-white mt-2">${value}</div>
			</div>
		`;
	}

	function showResult(outcome) {
		const winnerText =
			outcome.winner === 'player'
				? 'Player Wins!'
				: outcome.winner === 'banker'
					? 'Banker Wins!'
					: 'Tie!';
		const naturalText = outcome.isNatural ? ' (Natural!)' : '';
		const pairText = [
			outcome.playerPair ? 'Player Pair' : null,
			outcome.bankerPair ? 'Banker Pair' : null,
		]
			.filter(Boolean)
			.join(' | ');

		const resultsHTML = outcome.betResults
			.map((result) => {
				const outcomeClass =
					result.outcome === 'win'
						? 'text-green-400'
						: result.outcome === 'lose'
							? 'text-red-400'
							: 'text-yellow-400';
				const payoutPrefix = result.payout >= 0 ? '+' : '';
				const typeLabel = {
					player: 'Player',
					banker: 'Banker',
					tie: 'Tie',
					playerPair: 'P. Pair',
					bankerPair: 'B. Pair',
				}[result.bet.type];
				return `
					<div class="bet-result">
						<span>${typeLabel}</span>
						<span class="${outcomeClass}">${result.outcome.toUpperCase()}</span>
						<span class="${outcomeClass}">${payoutPrefix}$${result.payout}</span>
					</div>
				`;
			})
			.join('');

		const winnerEl = roundResultEl.querySelector('.result-winner');
		const scoresEl = roundResultEl.querySelector('.result-scores');
		const pairsEl = roundResultEl.querySelector('.result-pairs');
		const betsEl = roundResultEl.querySelector('.result-bets');

		if (winnerEl) {
			winnerEl.textContent = winnerText + naturalText;
		}
		if (scoresEl) {
			scoresEl.textContent = `Player: ${outcome.playerValue} | Banker: ${outcome.bankerValue}`;
		}
		if (pairsEl) {
			pairsEl.textContent = pairText;
		}
		if (betsEl) {
			betsEl.innerHTML = resultsHTML;
		}
		roundResultEl.classList.remove('hidden');

		// Update rendered hands with final values
		renderHand(playerHandEl, outcome.playerHand, 'PLAYER', 'blue');
		renderHand(bankerHandEl, outcome.bankerHand, 'BANKER', 'red');
	}

	function updateUI() {
		const state = game.getState();

		// Balance
		balanceEl.textContent = `$${state.chipBalance.toLocaleString()}`;

		// Shoe count
		shoeCountEl.textContent = `${state.shoeCardsRemaining} cards`;

		// Total bet
		const total = game.getBetTotal();
		totalBetEl.textContent = `$${total}`;

		// Deal button
		dealButton.disabled = !game.canDeal();

		// Active bets display
		if (state.activeBets.length === 0) {
			activeBetsEl.innerHTML = '<span class="text-neutral-500">No bets placed</span>';
		} else {
			activeBetsEl.innerHTML = state.activeBets
				.map((bet) => {
					const typeLabel = {
						player: 'Player',
						banker: 'Banker',
						tie: 'Tie',
						playerPair: 'P. Pair',
						bankerPair: 'B. Pair',
					}[bet.type];
					return `<div class="bet-chip"><span>${typeLabel}</span><span class="text-yellow-400">$${bet.amount}</span></div>`;
				})
				.join('');
		}

		// Update bet area amounts
		document.querySelectorAll('[data-bet-type]').forEach((area) => {
			const type = area.getAttribute('data-bet-type');
			const bet = state.activeBets.find((b) => b.type === type);
			const amountEl = area.querySelector('.bet-amount');
			if (amountEl) {
				amountEl.textContent = bet ? `$${bet.amount}` : '';
			}
			if (bet) {
				area.classList.add('bet-area-active');
			} else {
				area.classList.remove('bet-area-active');
			}
		});

		// Scoreboard
		if (state.roundHistory.length === 0) {
			scoreboardEl.innerHTML = '<span class="text-neutral-500">No history yet</span>';
		} else {
			scoreboardEl.innerHTML = state.roundHistory
				.map((round) => {
					const colorClass = {
						player: 'bg-blue-500',
						banker: 'bg-red-500',
						tie: 'bg-green-500',
					}[round.winner];
					const label = { player: 'P', banker: 'B', tie: 'T' }[round.winner];
					return `<span class="scoreboard-dot ${colorClass}">${label}</span>`;
				})
				.join('');
		}

		// Stats
		const stats = game.getStatistics();
		const totalRounds = stats.player + stats.banker + stats.tie;
		const getPercent = (count) => (totalRounds > 0 ? Math.round((count / totalRounds) * 100) : 0);

		const statPlayerEl = document.getElementById('stat-player');
		const statTieEl = document.getElementById('stat-tie');
		const statBankerEl = document.getElementById('stat-banker');

		if (statPlayerEl) {
			statPlayerEl.textContent = `${getPercent(stats.player)}%`;
		}
		if (statTieEl) {
			statTieEl.textContent = `${getPercent(stats.tie)}%`;
		}
		if (statBankerEl) {
			statBankerEl.textContent = `${getPercent(stats.banker)}%`;
		}
	}

	function showStatus(message) {
		statusEl.textContent = message;
		statusEl.classList.remove('hidden');
	}

	function hideStatus() {
		statusEl.classList.add('hidden');
	}

	let lastSyncedBalance = initialBalance;

	async function syncBalance() {
		const currentBalance = game.getBalance();
		const previousBalance = lastSyncedBalance;
		const delta = currentBalance - previousBalance;

		// Only sync if there's an actual change
		if (delta === 0) return;

		const performChipUpdate = async (retryCount = 0) => {
			const response = await fetch('/api/chips/update', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					delta,
					gameType: 'baccarat',
					previousBalance,
				}),
			});

			if (response.ok) {
				lastSyncedBalance = currentBalance;
				if (retryCount > 0) {
					showStatus('Balance synced successfully.');
				}
				return;
			}

			const errorData = await response.json().catch(() => ({}));

			if (errorData.error === 'RATE_LIMITED' && retryCount < 3) {
				const retryAfterHeader = response.headers.get('Retry-After');
				const retryAfterSeconds = parseInt(retryAfterHeader || '2', 10);
				const retryAfterMs = (Number.isNaN(retryAfterSeconds) ? 2 : retryAfterSeconds) * 1000;
				console.warn(
					`Chip update rate limited, retrying in ${retryAfterMs}ms (attempt ${retryCount + 1})`,
				);
				showStatus('Syncing balance...');
				setTimeout(() => {
					void performChipUpdate(retryCount + 1);
				}, retryAfterMs + 100);
				return;
			}

			if (errorData.currentBalance !== undefined) {
				const serverBalance = Number(errorData.currentBalance);
				if (!Number.isNaN(serverBalance)) {
					lastSyncedBalance = serverBalance;
					game.applyServerBalance(serverBalance);
					updateUI();
					showStatus(`Balance synced to ${serverBalance} chips.`);
				}
			} else if (errorData.error !== 'RATE_LIMITED') {
				// Revert to last known good balance when server did not provide a value
				game.applyServerBalance(lastSyncedBalance);
				updateUI();
			}

			if (errorData.error === 'BALANCE_MISMATCH') {
				console.warn('Balance mismatch detected, synced to server balance if provided.');
				showStatus('Balance corrected (server sync).');
			} else if (errorData.error === 'RATE_LIMITED') {
				console.error('Chip update rate limited, max retries exceeded');
				showStatus('Sync delayed. Balance will update on next round.');
			} else if (errorData.error === 'DELTA_EXCEEDS_LIMIT') {
				console.error('Delta exceeded server limit:', errorData.message);
				showStatus('Payout exceeded limit. Please try a smaller bet.');
			} else if (errorData.error === 'INSUFFICIENT_BALANCE') {
				showStatus(errorData.message || 'Insufficient balance on server.');
			} else {
				console.error('Chip update failed:', errorData.error, errorData.message);
				showStatus('Balance sync failed. Will retry next round.');
			}
		};

		try {
			await performChipUpdate();
		} catch (error) {
			console.error('Balance sync error:', error);
			game.applyServerBalance(lastSyncedBalance);
			updateUI();
			showStatus('Network error. Balance reverted.');
		}
	}

	// Initial UI update
	updateUI();
</script>

---
import CasinoLayout from '../layouts/casino.astro';
import { createDb } from '../lib/db';
import { getLlmSettings, AI_MODELS, AI_PROVIDERS } from '../lib/llm-settings';
import {
	getAchievementsWithStatus,
	getAchievementProgress,
} from '../lib/achievements/achievements';
import type { AchievementWithStatus } from '../lib/achievements/types';

const session = Astro.locals.session;

if (!session) {
	return Astro.redirect('/signin');
}

const { user } = session;
const fallbackInitial = user?.name?.[0]?.toUpperCase() ?? user?.email?.[0]?.toUpperCase() ?? 'A';

const runtime = Astro.locals.runtime;

const dbBinding = runtime?.env?.DB ?? null;

let aiSettings = {
	provider: 'openai',
	model: 'gpt-4o',
	openaiApiKey: null as string | null,
	geminiApiKey: null as string | null,
	updatedAt: new Date(0),
};

// Achievements data
let achievements: AchievementWithStatus[] = [];
let achievementProgress = { total: 0, unlocked: 0, percentage: 0 };
let achievementsFetchError = false;
const clampedPercentage = () => Math.round(Math.min(100, Math.max(0, achievementProgress.percentage)));

if (dbBinding) {
	const db = createDb(dbBinding);
	try {
		const result = await getLlmSettings(db, user.id);
		aiSettings = {
			provider: result.provider,
			model: result.model,
			openaiApiKey: result.openaiApiKey ?? null,
			geminiApiKey: result.geminiApiKey ?? null,
			updatedAt: result.updatedAt,
		};
	} catch (error) {
		console.error('Error loading AI settings:', error);
	}

	try {
		// Fetch achievements
		[achievements, achievementProgress] = await Promise.all([
			getAchievementsWithStatus(db, user.id),
			getAchievementProgress(db, user.id),
		]);
		achievementsFetchError = false;
	} catch (error) {
		console.error('Error loading achievements:', error);
		achievementsFetchError = true;
	}
}

const aiModelOptions = AI_MODELS;
const aiProviderOptions = AI_PROVIDERS;
const providerLabels = {
	openai: 'OpenAI',
	gemini: 'Gemini',
} as const;
const modelLabels: Record<string, string> = {
	'gpt-4o': 'GPT-4o',
	'gemini-2.5-flash': 'Gemini 2.5 Flash',
	'gemini-2.5-flash-lite': 'Gemini 2.5 Flash Lite',
};
const aiSettingsPayload = JSON.stringify({
	provider: aiSettings.provider,
	model: aiSettings.model,
	// Never send actual API keys to the client (security)
	hasOpenaiKey: Boolean(aiSettings.openaiApiKey),
	hasGeminiKey: Boolean(aiSettings.geminiApiKey),
	updatedAt: aiSettings.updatedAt.toISOString(),
});
---

<CasinoLayout title="Player Profile - Arcturus Casino">
	<section class="relative overflow-hidden">
		<div class="absolute inset-0 pointer-events-none">
			<div class="absolute top-24 -left-20 h-72 w-72 bg-yellow-500/10 rounded-full blur-3xl"></div>
			<div class="absolute bottom-10 right-0 h-64 w-64 bg-amber-500/10 rounded-full blur-3xl"></div>
		</div>

		<div class="relative max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
			<div class="bg-slate-900/80 border border-yellow-500/20 rounded-3xl shadow-2xl">
				<div class="flex flex-col gap-10 p-8 sm:p-12">
					<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-8">
						<div class="flex items-center gap-5">
							<div
								data-testid="user-avatar"
								class="flex h-20 w-20 items-center justify-center rounded-2xl bg-gradient-to-br from-yellow-400 via-amber-500 to-yellow-600 text-3xl font-bold text-slate-900"
							>
								{
									user.image ? (
										<img
											src={user.image}
											alt={user.name ?? user.email ?? 'Player Avatar'}
											class="h-20 w-20 rounded-2xl object-cover"
										/>
									) : (
										<span>{fallbackInitial}</span>
									)
								}
							</div>
							<div>
								<p class="text-sm uppercase tracking-widest text-yellow-400/80">Player Profile</p>
								<h1 class="mt-2 text-3xl font-semibold text-white">
									{user.name ?? 'Casino Adventurer'}
								</h1>
								<p class="text-slate-400">{user.email}</p>
							</div>
						</div>
						<div class="flex items-center gap-4 self-start md:self-auto">
							<span
								class={`inline-flex items-center gap-2 rounded-full border px-4 py-1 text-xs font-semibold uppercase tracking-widest ${
									user.emailVerified
										? 'border-emerald-400/40 text-emerald-300'
										: 'border-yellow-500/40 text-yellow-300'
								}`}
							>
								{user.emailVerified ? 'Email Verified' : 'Verification Pending'}
							</span>
							<button
								id="signout-btn"
								type="button"
								class="group relative inline-flex items-center gap-2 overflow-hidden rounded-full border border-yellow-500/40 bg-slate-900/60 px-6 py-3 text-sm font-semibold text-yellow-300 transition focus:outline-none focus:ring-2 focus:ring-yellow-500/60 focus:ring-offset-2 focus:ring-offset-slate-900"
							>
								<span
									class="absolute inset-0 -z-10 translate-y-full bg-gradient-to-r from-yellow-400 via-amber-500 to-yellow-600 opacity-90 transition-transform duration-300 group-hover:translate-y-0"
								></span>
								<span class="group-hover:text-slate-900">Sign out</span>
							</button>
						</div>
					</div>

					<div class="grid grid-cols-1 gap-6 md:grid-cols-2">
						<div class="rounded-2xl border border-white/5 bg-slate-950/40 p-6">
							<h2 class="text-lg font-semibold text-white">Account Details</h2>
							<dl class="mt-6 space-y-4 text-sm text-slate-300">
								<div class="flex items-start justify-between">
									<dt class="text-slate-400">Player Name</dt>
									<dd class="font-medium text-white">{user.name ?? 'Not set'}</dd>
								</div>
								<div class="flex items-start justify-between">
									<dt class="text-slate-400">Email Address</dt>
									<dd class="font-medium text-white">{user.email}</dd>
								</div>
								<div class="flex items-start justify-between">
									<dt class="text-slate-400">Email Status</dt>
									<dd class="font-medium text-white">
										{user.emailVerified ? 'Verified' : 'Awaiting verification'}
									</dd>
								</div>
							</dl>
						</div>
						<div class="rounded-2xl border border-white/5 bg-slate-950/40 p-6">
							<h2 class="text-lg font-semibold text-white">Casino Tips</h2>
							<ul class="mt-6 space-y-4 text-sm text-slate-300">
								<li class="flex items-start gap-3">
									<span class="text-xl">üéÅ</span>
									<span>Claim your daily chip bonus to keep the games going.</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-xl">üèÜ</span>
									<span>Visit the tournaments page to join upcoming events.</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-xl">ü§ù</span>
									<span>Invite friends for exclusive in-game rewards.</span>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>

			<div class="mt-8 rounded-2xl border border-white/5 bg-slate-950/40 p-6">
				<div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
					<div>
						<h2 class="text-lg font-semibold text-white">AI Rival Settings</h2>
						<p class="text-sm text-slate-400">
							Choose your model provider and store API keys to enable the Gemini or OpenAI poker
							rival.
						</p>
					</div>
					<p
						id="ai-settings-feedback"
						class="text-xs font-semibold uppercase tracking-widest text-slate-400 text-right"
					>
						Updated {
							aiSettings.updatedAt.getTime() ? aiSettings.updatedAt.toLocaleDateString() : '‚Äî'
						}
					</p>
				</div>

				<form
					id="ai-settings-form"
					class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2"
					data-initial-provider={aiSettings.provider}
					data-initial-settings={aiSettingsPayload}
				>
					<div class="col-span-full sm:col-span-1">
						<label for="ai-provider" class="block text-sm font-medium text-slate-200">
							Model Provider
						</label>
						<select
							id="ai-provider"
							name="provider"
							class="mt-2 w-full rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-white focus:border-yellow-500 focus:outline-none focus:ring-1 focus:ring-yellow-500"
						>
							{
								aiProviderOptions.map((provider) => (
									<option value={provider} selected={aiSettings.provider === provider}>
										{providerLabels[provider]}
									</option>
								))
							}
						</select>
					</div>
					<div class="col-span-full sm:col-span-1">
						<label for="ai-model" class="block text-sm font-medium text-slate-200">
							Model Variant
						</label>
						<select
							id="ai-model"
							name="model"
							class="mt-2 w-full rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-white focus:border-yellow-500 focus:outline-none focus:ring-1 focus:ring-yellow-500"
							data-model-options={JSON.stringify(aiModelOptions)}
							data-model-labels={JSON.stringify(modelLabels)}
							data-initial-model={aiSettings.model}
						>
							{
								aiModelOptions[aiSettings.provider as keyof typeof aiModelOptions].map(
									(model: string) => (
										<option value={model} selected={aiSettings.model === model}>
											{modelLabels[model] ?? model}
										</option>
									),
								)
							}
						</select>
					</div>

					<div class="col-span-full space-y-2">
						<label
							id="api-key-label"
							for="api-key"
							class="block text-sm font-medium text-slate-200"
						>
							{aiSettings.provider === 'openai' ? 'OpenAI API Key' : 'Gemini API Key'}
						</label>
						<div class="flex flex-col gap-2 sm:flex-row sm:items-center">
							<div class="relative flex-1">
								<input
									id="api-key"
									name="apiKey"
									type="password"
									placeholder={aiSettings.provider === 'openai' ? 'sk-...' : 'AIza...'}
									class="w-full rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 pr-20 text-sm text-white focus:border-yellow-500 focus:outline-none focus:ring-1 focus:ring-yellow-500"
									autocomplete="off"
								/>
								<div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
									<button
										type="button"
										id="show-api-key"
										class="p-1.5 text-slate-400 hover:text-yellow-400 focus:outline-none focus:ring-1 focus:ring-yellow-500 rounded transition-colors"
										title="Show API key"
										style="display: none;"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
										>
											<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
											<circle cx="12" cy="12" r="3"></circle>
										</svg>
									</button>
									<button
										type="button"
										id="hide-api-key"
										class="p-1.5 text-slate-400 hover:text-yellow-400 focus:outline-none focus:ring-1 focus:ring-yellow-500 rounded transition-colors"
										title="Hide API key"
										style="display: none;"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
										>
											<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path>
											<path
												d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"
											></path>
											<path
												d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"
											></path>
											<line x1="2" x2="22" y1="2" y2="22"></line>
										</svg>
									</button>
									<button
										type="button"
										id="copy-api-key"
										class="p-1.5 text-slate-400 hover:text-yellow-400 focus:outline-none focus:ring-1 focus:ring-yellow-500 rounded transition-colors"
										title="Copy API key"
										style="display: none;"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
										>
											<rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
											<path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
										</svg>
									</button>
								</div>
							</div>
							<div class="flex items-center gap-2">
								<span
									id="api-key-status"
									class="text-xs font-semibold uppercase tracking-widest text-slate-400"
								>
									{
										(aiSettings.provider === 'openai' && aiSettings.openaiApiKey) ||
										(aiSettings.provider === 'gemini' && aiSettings.geminiApiKey)
											? 'Saved'
											: 'Not saved'
									}
								</span>
								<button
									type="button"
									id="clear-api-key"
									class="text-xs text-rose-400 hover:text-rose-300 underline focus:outline-none focus:ring-1 focus:ring-rose-500 rounded px-1"
									style="display: none;"
								>
									Clear
								</button>
							</div>
						</div>
						<p id="api-key-help" class="text-xs text-slate-400">
							{
								aiSettings.provider === 'openai'
									? 'Required for the GPT-4o rival. Keys are stored per account and never shown back in full.'
									: 'Used for Gemini Flash rivals. Leave blank to keep the previously stored key.'
							}
						</p>
					</div>

					<div class="col-span-full flex justify-end">
						<button
							type="submit"
							class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-yellow-500 via-amber-500 to-yellow-600 px-4 py-2 text-sm font-semibold text-slate-900 transition hover:from-yellow-400 hover:to-amber-500 focus:outline-none focus:ring-2 focus:ring-yellow-500/60 focus:ring-offset-2 focus:ring-offset-slate-950"
						>
							Save Rival Preferences
						</button>
					</div>
				</form>
			</div>

			<!-- Achievements Section -->
			<div class="mt-8 rounded-2xl border border-white/5 bg-slate-950/40 p-6">
				<div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
					<div>
						<h2 class="text-lg font-semibold text-white">Achievements & Badges</h2>
						<p class="text-sm text-slate-400">
							Earn badges by reaching milestones and accomplishing feats across all casino games.
						</p>
					</div>
					<div class="text-right">
						<p class="text-2xl font-bold text-yellow-400">
							{achievementProgress.unlocked}/{achievementProgress.total}
						</p>
						<p class="text-xs text-slate-400 uppercase tracking-widest">Unlocked</p>
					</div>
				</div>

				<!-- Progress Bar -->
				<div
					class="mt-4 h-2 w-full rounded-full bg-slate-800 overflow-hidden"
					role="progressbar"
					aria-label="Achievement progress"
					aria-valuemin="0"
					aria-valuemax="100"
					aria-valuenow={clampedPercentage()}
					aria-valuetext={`${clampedPercentage()}%`}
				>
					<div
						class="h-full bg-gradient-to-r from-yellow-500 to-amber-500 transition-all duration-500"
						style={`width: ${clampedPercentage()}%`}
					>
					</div>
				</div>

				<!-- Achievements Grid -->
				<div class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
					{
						achievements.map((achievement) => (
							<div
								class={`relative rounded-xl border p-4 transition-all ${
									achievement.isUnlocked
										? 'border-yellow-500/40 bg-gradient-to-br from-yellow-500/10 to-amber-500/5'
										: 'border-slate-700/50 bg-slate-900/50 opacity-60'
								}`}
								data-testid={`achievement-${achievement.id}`}
							>
								<div class="flex items-start gap-3">
									<div
										class={`flex h-12 w-12 items-center justify-center rounded-lg text-2xl ${
											achievement.isUnlocked
												? 'bg-gradient-to-br from-yellow-400/20 to-amber-500/20'
												: 'bg-slate-800/50 grayscale'
										}`}
									>
										{achievement.icon}
									</div>
									<div class="flex-1 min-w-0">
										<h3
											class={`font-semibold ${
												achievement.isUnlocked ? 'text-white' : 'text-slate-400'
											}`}
										>
											{achievement.name}
										</h3>
										<p class="text-xs text-slate-400 mt-0.5">{achievement.description}</p>
										{achievement.isUnlocked && achievement.earnedAt && (
											<p class="text-xs text-yellow-400/70 mt-1">
												Earned{' '}
												{new Date(achievement.earnedAt).toLocaleDateString('en-US', {
													month: 'short',
													day: 'numeric',
													year: 'numeric',
												})}
											</p>
										)}
									</div>
								</div>
								{achievement.isUnlocked && (
									<div class="absolute top-2 right-2">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
											class="text-yellow-400"
										>
											<polyline points="20 6 9 17 4 12" />
										</svg>
									</div>
								)}
							</div>
						))
					}
				</div>

				{
					achievementsFetchError ? (
						<div class="mt-6 text-center py-8">
							<p class="text-rose-400">
								Unable to load achievements ‚Äî try again
							</p>
						</div>
					) : achievements.length === 0 ? (
						<div class="mt-6 text-center py-8">
							<p class="text-slate-400">
								No achievements available yet. Start playing to earn badges!
							</p>
						</div>
					) : null
				}
			</div>
		</div>
	</section>

	<!-- Toast Notification -->
	<div
		id="toast-notification"
		class="fixed bottom-4 right-4 bg-emerald-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transition-all duration-300 opacity-0 pointer-events-none translate-y-2"
		style="z-index: 9999;"
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			width="20"
			height="20"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="2"
			stroke-linecap="round"
			stroke-linejoin="round"
		>
			<polyline points="20 6 9 17 4 12"></polyline>
		</svg>
		<span id="toast-message">Copied to clipboard!</span>
	</div>
</CasinoLayout>

<script>
	import { authClient } from '../lib/auth-client';
	import { ProfileUiState, type AiState } from '../lib/profile-ui-state';
	import { fetchApiKey } from '../lib/profile-api';
	import { populateModels, showToast, handleAiSettingsSubmit } from '../lib/profile-form-handlers';

	// Sign out handler
	const signoutBtn = document.getElementById('signout-btn');
	signoutBtn?.addEventListener('click', async () => {
		try {
			await authClient.signOut();
			window.location.href = '/signin';
		} catch (error) {
			console.error('Sign out error:', error);
		}
	});

	// Initialize AI state from form data
	let aiState: AiState = {
		provider: 'openai',
		model: 'gpt-4o',
		hasOpenaiKey: false,
		hasGeminiKey: false,
	};

	const aiForm = document.getElementById('ai-settings-form');
	if (aiForm instanceof HTMLFormElement && typeof aiForm.dataset.initialSettings === 'string') {
		try {
			const parsed = JSON.parse(aiForm.dataset.initialSettings);
			aiState = {
				provider: parsed.provider ?? aiState.provider,
				model: parsed.model ?? aiState.model,
				hasOpenaiKey: Boolean(parsed.hasOpenaiKey),
				hasGeminiKey: Boolean(parsed.hasGeminiKey),
			};
		} catch (error) {
			console.error('Failed to parse initial AI settings:', error);
		}
	}

	// Get DOM elements
	const providerSelect = document.getElementById('ai-provider') as HTMLSelectElement | null;
	const modelSelect = document.getElementById('ai-model') as HTMLSelectElement | null;
	const apiKeyInput = document.getElementById('api-key') as HTMLInputElement | null;
	const apiKeyLabel = document.getElementById('api-key-label');
	const apiKeyStatus = document.getElementById('api-key-status');
	const apiKeyHelp = document.getElementById('api-key-help');
	const clearKeyButton = document.getElementById('clear-api-key') as HTMLButtonElement | null;
	const showKeyButton = document.getElementById('show-api-key') as HTMLButtonElement | null;
	const hideKeyButton = document.getElementById('hide-api-key') as HTMLButtonElement | null;
	const copyKeyButton = document.getElementById('copy-api-key') as HTMLButtonElement | null;
	const feedbackEl = document.getElementById('ai-settings-feedback');
	const toastEl = document.getElementById('toast-notification');
	const toastMessage = document.getElementById('toast-message');

	// Parse model options and labels
	let modelOptions: Record<string, string[]> = {};
	if (typeof modelSelect?.dataset.modelOptions === 'string') {
		try {
			modelOptions = JSON.parse(modelSelect.dataset.modelOptions);
		} catch (error) {
			console.error('Failed to parse model options dataset:', error);
		}
	}

	let modelLabels: Record<string, string> = {};
	if (typeof modelSelect?.dataset.modelLabels === 'string') {
		try {
			modelLabels = JSON.parse(modelSelect.dataset.modelLabels);
		} catch (error) {
			console.error('Failed to parse model labels dataset:', error);
		}
	}

	// Initialize UI state manager
	const uiState = new ProfileUiState(
		{
			apiKeyInput,
			apiKeyLabel,
			apiKeyStatus,
			apiKeyHelp,
			clearKeyButton,
			showKeyButton,
			hideKeyButton,
			copyKeyButton,
		},
		aiState,
	);

	// Track if user wants to explicitly clear the API key
	let clearKeyRequested = false;

	// Initialize provider select and populate models
	if (providerSelect) {
		providerSelect.value = aiState.provider;
		populateModels(modelSelect, aiState.provider, aiState.model, modelOptions, modelLabels);
		uiState.updateApiKeyUI(aiState.provider);

		providerSelect.addEventListener('change', () => {
			const nextProvider = providerSelect.value;
			populateModels(
				modelSelect,
				nextProvider,
				modelSelect?.value ?? '',
				modelOptions,
				modelLabels,
			);
			clearKeyRequested = false;
			uiState.clearRevealedKey();
			uiState.updateApiKeyUI(nextProvider, false);
		});
	}

	// Show API key button
	if (showKeyButton) {
		showKeyButton.addEventListener('click', async () => {
			const currentProvider = providerSelect?.value ?? aiState.provider;
			const success = await uiState.revealApiKey(currentProvider, fetchApiKey);
			if (success) {
				uiState.updateApiKeyUI(currentProvider);
			}
		});
	}

	// Hide API key button
	if (hideKeyButton) {
		hideKeyButton.addEventListener('click', () => {
			const currentProvider = providerSelect?.value ?? aiState.provider;
			uiState.hideApiKey(currentProvider);
			uiState.updateApiKeyUI(currentProvider);
		});
	}

	// Copy API key button
	if (copyKeyButton) {
		copyKeyButton.addEventListener('click', async () => {
			const currentProvider = providerSelect?.value ?? aiState.provider;
			const success = await uiState.copyApiKey(currentProvider, fetchApiKey);
			if (success) {
				showToast(toastEl, toastMessage, 'API key copied to clipboard!');
			} else {
				showToast(toastEl, toastMessage, 'Failed to copy to clipboard');
			}
		});
	}

	// Clear API key button
	if (clearKeyButton) {
		clearKeyButton.addEventListener('click', () => {
			if (confirm('Are you sure you want to remove your saved API key?')) {
				clearKeyRequested = true;
				if (apiKeyInput) {
					apiKeyInput.value = '';
				}
				if (aiForm instanceof HTMLFormElement) {
					aiForm.requestSubmit();
				}
			}
		});
	}

	// Form submission
	aiForm?.addEventListener('submit', async (event) => {
		await handleAiSettingsSubmit(
			event as SubmitEvent,
			aiState,
			providerSelect,
			modelSelect,
			apiKeyInput,
			clearKeyRequested,
			feedbackEl,
			(updatedState) => {
				// On success, update state and UI
				uiState.updateAiState(updatedState);
				Object.assign(aiState, updatedState);

				if (providerSelect && providerSelect.value !== aiState.provider) {
					providerSelect.value = aiState.provider;
				}

				populateModels(modelSelect, aiState.provider, aiState.model, modelOptions, modelLabels);
				uiState.updateApiKeyUI(aiState.provider);
			},
		);

		// Reset clear flag after submission
		clearKeyRequested = false;
	});
</script>
